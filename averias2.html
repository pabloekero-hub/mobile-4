
<!DOCTYPE html>
<html lang="es" class="h-full bg-slate-50">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FleetManager Pro - v55 (Averías + Termógrafo)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; height: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 10px; }
        .custom-scrollbar:hover::-webkit-scrollbar-thumb { background-color: #94a3b8; }
        .nav-item { transition: all 0.2s ease-in-out; }
        .nav-item:hover { background-color: rgba(255,255,255,0.1); transform: translateX(4px); }
        .nav-item.active { background-color: #3b82f6; color: white; box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.5); }
        .card-hover { transition: transform 0.2s, box-shadow 0.2s; }
        .card-hover:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .checkbox-wrapper input:checked + div { background-color: #2563eb; border-color: #2563eb; }
        .checkbox-wrapper input:checked + div:after { content: ''; display: block; position: absolute; top: 2px; left: 6px; width: 4px; height: 8px; border: solid white; border-width: 0 2px 2px 0; transform: rotate(45deg); }
        [v-cloak] { display: none; }
        .animate-pop { animation: pop 0.2s ease-out; }
        @keyframes pop { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
        .circular-chart { display: block; margin: 0 auto; max-width: 100%; max-height: 250px; }
        .circle-bg { fill: none; stroke: #e2e8f0; stroke-width: 2.5; }
        .circle { fill: none; stroke-width: 2.5; stroke-linecap: round; animation: progress 1s ease-out forwards; }
        @keyframes progress { 0% { stroke-dasharray: 0 100; } }
        .fade-enter-active, .fade-leave-active { transition: opacity 0.2s ease, transform 0.2s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; transform: translateY(5px) translateX(-50%); }
    </style>
</head>
<body class="h-full overflow-hidden text-slate-600">

<div id="app" class="h-full flex relative" v-cloak>

    <transition name="fade">
        <div v-if="tooltip.visible" 
             class="fixed z-[9999] bg-white rounded-xl shadow-2xl w-72 border border-slate-200 overflow-hidden pointer-events-none hidden md:block"
             :style="{ top: tooltip.y + 'px', left: tooltip.x + 'px', transform: 'translateX(-50%)' }">
            <div class="h-2 w-full" :style="{ backgroundColor: tooltip.data.color || '#3b82f6' }"></div>
            <div class="p-4">
                <div class="flex items-start justify-between mb-3">
                    <div>
                        <div class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Ruta</div>
                        <div class="font-extrabold text-slate-800 text-sm leading-tight">{{ tooltip.data.rutaNombreManual || tooltip.data.rutaNombre }}</div>
                    </div>
                    <div class="bg-slate-100 px-2 py-1 rounded text-[10px] font-bold text-slate-500">{{ tooltip.data.horaSalida }}</div>
                </div>
                <div class="flex items-center gap-2 text-xs text-slate-500 mb-4 bg-slate-50 p-2 rounded-lg border border-slate-100">
                    <div class="flex-1 text-center"><span class="block font-bold text-slate-700">{{ tooltip.data.horaSalida }}</span><span class="text-[9px] uppercase">Salida</span></div>
                    <div class="text-slate-300"><i class="fas fa-arrow-right"></i></div>
                    <div class="flex-1 text-center"><span class="block font-bold text-slate-700">{{ tooltip.data.horaLlegada }}</span><span class="text-[9px] uppercase">Llegada</span></div>
                </div>
                <div class="space-y-2">
                    <div class="flex items-center"><div class="w-6 h-6 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center text-xs mr-2 shadow-sm"><i class="fas fa-steering-wheel"></i></div><div><div class="text-[10px] font-bold text-slate-400 uppercase">Conductor 1</div><div class="text-xs font-bold text-slate-700">{{ tooltip.data.choferNombre }}</div></div></div>
                    <div v-if="tooltip.data.chofer2Nombre" class="flex items-center"><div class="w-6 h-6 rounded-full bg-purple-100 text-purple-600 flex items-center justify-center text-xs mr-2 shadow-sm"><i class="fas fa-user-plus"></i></div><div><div class="text-[10px] font-bold text-slate-400 uppercase">Conductor 2</div><div class="text-xs font-bold text-slate-700">{{ tooltip.data.chofer2Nombre }}</div></div></div>
                    <div v-if="tooltip.data.cargadorNombre" class="flex items-center pt-1 mt-1 border-t border-dashed border-slate-200"><div class="w-6 h-6 rounded-full bg-orange-100 text-orange-600 flex items-center justify-center text-xs mr-2 shadow-sm"><i class="fas fa-dolly"></i></div><div><div class="text-[10px] font-bold text-slate-400 uppercase">Cargador</div><div class="text-xs font-bold text-slate-700">{{ tooltip.data.cargadorNombre }}</div></div></div>
                </div>
                <div class="mt-3 pt-2 border-t border-slate-100 flex justify-between items-center"><div class="text-[10px] bg-gray-100 text-gray-600 px-2 py-0.5 rounded font-mono">{{ tooltip.data.tractoraPlaca }}</div><div class="text-[9px] text-slate-400 italic">Click para editar</div></div>
            </div>
        </div>
    </transition>

    <div v-if="menuMovilAbierto" class="fixed inset-0 bg-black/50 z-40 md:hidden backdrop-blur-sm" @click="menuMovilAbierto = false"></div>

    <aside :class="['fixed inset-y-0 left-0 z-50 w-64 bg-slate-900 text-slate-300 flex flex-col shadow-xl transition-transform duration-300 md:translate-x-0 md:static md:inset-auto', menuMovilAbierto ? 'translate-x-0' : '-translate-x-full']">
        <div class="h-16 flex items-center px-6 bg-slate-950 shadow-sm flex-none relative overflow-hidden group justify-between md:justify-start">
            <div class="text-xl font-bold tracking-wide flex items-center relative z-10 text-white">
                <div class="bg-gradient-to-br from-blue-500 to-indigo-600 p-2 rounded-lg mr-3 shadow-lg"><i class="fas fa-truck-moving text-white text-sm"></i></div>
                <div>Fleet<span class="text-blue-400">Manager</span> <span class="text-xs font-medium text-slate-500 ml-1">v55</span></div>
            </div>
            <button @click="menuMovilAbierto = false" class="md:hidden text-slate-400 hover:text-white"><i class="fas fa-times"></i></button>
        </div>

        <nav class="flex-1 py-6 px-3 space-y-2 overflow-y-auto custom-scrollbar">
            <h3 class="px-3 text-xs font-semibold text-slate-500 uppercase tracking-wider mb-3">Principal</h3>
            <button @click="cambiarVista('inicio'); menuMovilAbierto = false" :class="vistaActual === 'inicio' ? 'active' : ''" class="nav-item w-full flex items-center px-3 py-2.5 rounded-lg text-sm font-medium relative group">
                <i class="fas fa-home w-6 h-6 flex items-center justify-center mr-3 text-lg opacity-80 group-hover:opacity-100 transition-opacity"></i> Inicio
                <span v-if="alertasVencimiento.length > 0 || averiasActivas.length > 0" class="absolute right-2 top-1/2 -translate-y-1/2 bg-red-500 text-white text-[10px] font-bold px-2 py-0.5 rounded-full shadow-sm animate-pulse">{{ alertasVencimiento.length + averiasActivas.length }}</span>
            </button>
            <button @click="cambiarVista('diario'); menuMovilAbierto = false" :class="vistaActual === 'diario' ? 'active' : ''" class="nav-item w-full flex items-center px-3 py-2.5 rounded-lg text-sm font-medium group text-emerald-400">
                <i class="fas fa-clipboard-list w-6 h-6 flex items-center justify-center mr-3 text-lg opacity-80 group-hover:opacity-100 transition-opacity"></i> Diario de Viajes
            </button>
            <button @click="cambiarVista('calendario'); menuMovilAbierto = false" :class="vistaActual === 'calendario' ? 'active' : ''" class="nav-item w-full flex items-center px-3 py-2.5 rounded-lg text-sm font-medium group">
                <i class="fas fa-calendar-alt w-6 h-6 flex items-center justify-center mr-3 text-lg opacity-80 group-hover:opacity-100 transition-opacity"></i> Calendario
            </button>
            
            <h3 class="px-3 text-xs font-semibold text-slate-500 uppercase tracking-wider mb-3 mt-8">Analítica</h3>
            <button @click="cambiarVista('contabilidad'); menuMovilAbierto = false" :class="vistaActual === 'contabilidad' ? 'active' : ''" class="nav-item w-full flex items-center px-3 py-2.5 rounded-lg text-sm font-medium group">
                <i class="fas fa-route w-6 h-6 flex items-center justify-center mr-3 text-lg opacity-80 group-hover:opacity-100 transition-opacity"></i> Análisis Rutas
            </button>
            <button @click="cambiarVista('analisisChofer'); menuMovilAbierto = false" :class="vistaActual === 'analisisChofer' ? 'active' : ''" class="nav-item w-full flex items-center px-3 py-2.5 rounded-lg text-sm font-medium group">
                <i class="fas fa-user-clock w-6 h-6 flex items-center justify-center mr-3 text-lg opacity-80 group-hover:opacity-100 transition-opacity"></i> Análisis Chófer
            </button>
            <button @click="cambiarVista('flota'); menuMovilAbierto = false" :class="vistaActual === 'flota' ? 'active' : ''" class="nav-item w-full flex items-center px-3 py-2.5 rounded-lg text-sm font-medium group relative">
                <i class="fas fa-truck w-6 h-6 flex items-center justify-center mr-3 text-lg opacity-80 group-hover:opacity-100 transition-opacity"></i> Estado Flota
                <span v-if="averiasActivas.length > 0" class="absolute right-2 top-1/2 -translate-y-1/2 bg-red-500 text-white text-[10px] font-bold px-2 py-0.5 rounded-full shadow-sm">{{ averiasActivas.length }}</span>
            </button>
            
            <h3 class="px-3 text-xs font-semibold text-slate-500 uppercase tracking-wider mb-3 mt-8">Gestión</h3>
            <button @click="cambiarVista('admin'); menuMovilAbierto = false" :class="vistaActual === 'admin' ? 'active' : ''" class="nav-item w-full flex items-center px-3 py-2.5 rounded-lg text-sm font-medium group">
                <i class="fas fa-database w-6 h-6 flex items-center justify-center mr-3 text-lg opacity-80 group-hover:opacity-100 transition-opacity"></i> Administración
            </button>
        </nav>
    </aside>

    <main class="flex-1 flex flex-col bg-gray-50 overflow-hidden relative w-full">

        <header class="h-16 bg-white border-b border-gray-200 flex items-center justify-between px-4 md:px-6 shadow-sm flex-none z-30 relative">
            <div class="flex items-center">
                <button @click="menuMovilAbierto = true" class="md:hidden mr-4 text-slate-500 hover:text-blue-600 focus:outline-none"><i class="fas fa-bars text-xl"></i></button>
                <h2 class="text-lg md:text-xl font-semibold text-slate-800 capitalize truncate max-w-[150px] md:max-w-none">
                    {{ vistaActual === 'contabilidad' ? 'Rentabilidad' : 
                       vistaActual === 'analisisChofer' ? 'Rendimiento' :
                       vistaActual === 'flota' ? 'Estado de Flota' :
                       vistaActual === 'diario' ? 'Diario' :
                       vistaActual === 'inicio' ? 'Visión General' : vistaActual }}
                </h2>
            </div>
            
            <div class="flex gap-2 items-center" v-if="vistaActual === 'diario'">
                 <div class="hidden md:flex items-center bg-gray-100 p-1 rounded-lg border border-gray-200">
                    <button @click="cambiarDiaDiario(-1)" class="w-8 h-8 flex items-center justify-center hover:bg-white rounded-md text-gray-500 hover:text-blue-600 transition"><i class="fas fa-chevron-left"></i></button>
                    <input type="date" v-model="fechaDiario" class="bg-transparent border-none text-sm font-bold text-slate-700 px-2 outline-none w-32 text-center">
                    <button @click="cambiarDiaDiario(1)" class="w-8 h-8 flex items-center justify-center hover:bg-white rounded-md text-gray-500 hover:text-blue-600 transition"><i class="fas fa-chevron-right"></i></button>
                 </div>
                 <input type="date" v-model="fechaDiario" class="md:hidden bg-gray-100 border border-gray-200 text-sm font-bold text-slate-700 rounded-lg px-2 py-1.5 outline-none w-32">
                 <button @click="setDiaDiarioHoy" class="hidden md:block text-sm font-bold text-blue-600 hover:bg-blue-50 px-3 py-2 rounded-lg transition">Hoy</button>
                 <div class="h-6 w-px bg-gray-300 mx-2 hidden md:block"></div>
                 <button @click="abrirModalViaje(fechaDiario)" class="bg-emerald-600 hover:bg-emerald-700 text-white text-sm font-bold py-2 px-3 md:px-4 rounded-lg shadow-md flex items-center"><i class="fas fa-plus md:mr-2"></i> <span class="hidden md:inline">Nuevo Viaje</span></button>
            </div>
            
            <div v-else-if="vistaActual === 'calendario'" class="flex items-center gap-2">
                 <div class="bg-gray-100 p-1 rounded-lg flex shadow-inner border border-gray-200 hidden md:flex">
                    <button @click="calendarView = 'month'" :class="calendarView === 'month' ? 'bg-white text-blue-600 shadow-sm font-bold' : 'text-gray-500'" class="px-3 py-1.5 rounded-md text-xs transition-all">Mes</button>
                    <button @click="calendarView = '2weeks'" :class="calendarView === '2weeks' ? 'bg-white text-blue-600 shadow-sm font-bold' : 'text-gray-500'" class="px-3 py-1.5 rounded-md text-xs transition-all">2 Sem.</button>
                    <button @click="calendarView = 'list'" :class="calendarView === 'list' ? 'bg-white text-blue-600 shadow-sm font-bold' : 'text-gray-500'" class="px-3 py-1.5 rounded-md text-xs transition-all flex items-center"><i class="fas fa-list-ul mr-1"></i> Rango</button>
                </div>
                <select v-model="calendarView" class="md:hidden bg-gray-100 border border-gray-200 text-xs font-bold text-slate-700 rounded-lg px-2 py-1.5 outline-none">
                    <option value="month">Mes</option>
                    <option value="2weeks">2 Sem.</option>
                    <option value="list">Lista</option>
                </select>
                <div v-if="calendarView === 'list'" class="hidden md:flex items-center bg-blue-50 p-1 rounded-lg border border-blue-100 animate-pop">
                    <span class="text-[10px] uppercase font-bold text-blue-400 ml-2 mr-1">Desde:</span>
                    <input type="date" v-model="filtrosCalendario.customStart" class="bg-transparent border-none text-xs font-bold text-blue-800 outline-none w-24">
                    <span class="text-[10px] uppercase font-bold text-blue-400 ml-2 mr-1">Hasta:</span>
                    <input type="date" v-model="filtrosCalendario.customEnd" class="bg-transparent border-none text-xs font-bold text-blue-800 outline-none w-24">
                </div>
                 <button @click="abrirModalViaje(null)" class="bg-blue-600 hover:bg-blue-700 text-white text-sm font-bold py-2 px-3 md:px-4 rounded-lg shadow-md flex items-center"><i class="fas fa-plus md:mr-2"></i> <span class="hidden md:inline">Nuevo</span></button>
            </div>
            <div v-else class="flex gap-3">
                 <button @click="abrirModalViaje(null)" class="bg-blue-600 hover:bg-blue-700 text-white text-sm font-bold py-2 px-3 md:px-4 rounded-lg shadow-md flex items-center"><i class="fas fa-plus md:mr-2"></i> <span class="hidden md:inline">Nuevo</span></button>
            </div>
        </header>

        <div class="flex-1 overflow-auto custom-scrollbar relative">

            <div v-if="vistaActual === 'inicio'" class="p-4 md:p-6 max-w-[1600px] mx-auto space-y-4 md:space-y-6 h-full flex flex-col">
                <div class="grid grid-cols-1 xl:grid-cols-3 gap-4 md:gap-6 flex-none min-h-[420px]">
                    <div class="xl:col-span-2 bg-white rounded-2xl shadow-sm border border-gray-100 p-5 flex flex-col relative overflow-hidden h-64 md:h-auto">
                        <div class="flex justify-between items-center mb-2"><div class="text-sm font-bold text-slate-700 uppercase tracking-wider">Evolución de Ingresos</div></div>
                        <div class="flex-1 w-full relative"><canvas id="dashboardRevenueChart"></canvas></div>
                    </div>
                    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 flex flex-col overflow-hidden h-64 md:h-auto">
                        <div class="p-4 border-b bg-gray-50 flex justify-between items-center flex-none"><h3 class="font-bold text-slate-700 text-sm">Comparativa Mensual</h3></div>
                        <div class="flex-1 overflow-y-auto custom-scrollbar">
                            <table class="w-full text-left border-collapse"><thead class="bg-slate-50 text-[10px] text-slate-500 uppercase font-semibold sticky top-0 z-10"><tr><th class="px-4 py-2 bg-slate-50">Ruta</th><th class="px-4 py-2 text-right bg-slate-50">Actual</th><th class="px-4 py-2 text-center bg-slate-50">%</th></tr></thead><tbody class="divide-y divide-gray-100 text-xs"><tr v-for="stat in dashboardStats.comparativaRutas" :key="stat.nombre"><td class="px-4 py-3 font-bold text-slate-700 truncate max-w-[120px]"><span class="w-2 h-2 rounded-full inline-block mr-2" :style="{background: stat.color}"></span>{{ stat.nombre }}</td><td class="px-4 py-3 text-right font-mono text-slate-600">{{ formatMoney(stat.actual) }}</td><td class="px-4 py-3 text-center font-bold" :class="stat.diff >= 0 ? 'text-emerald-600' : 'text-red-500'">{{ Math.abs(stat.pct).toFixed(0) }}%</td></tr></tbody></table>
                        </div>
                    </div>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-4 gap-4 md:gap-6 flex-1 min-h-0">
                     <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 flex flex-col justify-center space-y-6">
                        <div class="flex items-center justify-between"><div><div class="text-sm font-bold text-slate-400 uppercase">Viajes Hoy</div><div class="text-3xl font-bold text-slate-800">{{ dashboardStats.salidasHoy.length }}</div></div><div class="w-12 h-12 bg-blue-50 rounded-full flex items-center justify-center text-blue-600 text-xl"><i class="fas fa-truck-fast"></i></div></div>
                        <div class="flex items-center justify-between"><div><div class="text-sm font-bold text-slate-400 uppercase">Facturación Hoy</div><div class="text-3xl font-bold text-emerald-600">{{ formatMoney(dashboardStats.salidasHoy.reduce((a,b)=>a+(b.precioIda||0)+(b.precioVuelta||0),0)) }}</div></div><div class="w-12 h-12 bg-emerald-50 rounded-full flex items-center justify-center text-emerald-600 text-xl"><i class="fas fa-euro-sign"></i></div></div>
                     </div>
                     
                     <div class="bg-white rounded-2xl shadow-sm border border-gray-100 flex flex-col overflow-hidden h-64 md:h-auto">
                        <div class="p-4 border-b border-gray-100 flex justify-between items-center" :class="averiasActivas.length > 0 ? 'bg-red-50' : 'bg-gray-50'">
                            <h3 class="font-bold text-sm" :class="averiasActivas.length > 0 ? 'text-red-700' : 'text-slate-700'">
                                <i class="fas fa-tools mr-2"></i>Averías Activas
                            </h3>
                            <span v-if="averiasActivas.length > 0" class="bg-red-500 text-white text-[10px] px-2 py-0.5 rounded-full font-bold">{{ averiasActivas.length }}</span>
                        </div>
                        <div class="flex-1 overflow-y-auto custom-scrollbar p-3 space-y-2">
                            <div v-if="averiasActivas.length === 0" class="text-center text-green-500 py-4">
                                <i class="fas fa-check-circle text-3xl mb-2"></i>
                                <div class="text-xs font-bold">Sin averías</div>
                            </div>
                            <div v-for="averia in averiasActivas" :key="averia.id" class="bg-red-50 border border-red-100 rounded-lg p-2">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <div class="font-bold text-xs text-red-800">{{ averia.vehiculoMatricula }}</div>
                                        <div class="text-[10px] text-red-600 truncate max-w-[150px]">{{ averia.descripcion }}</div>
                                    </div>
                                    <div class="text-right">
                                        <div class="text-[10px] font-bold text-red-600">{{ calcularDiasAveria(averia) }} días</div>
                                        <div class="text-[9px] text-red-400">{{ formatDate(averia.fechaInicio) }}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                     </div>
                     
                     <div class="bg-white rounded-2xl shadow-sm border border-gray-100 flex flex-col overflow-hidden h-64 md:h-auto">
                        <div class="p-4 border-b border-gray-100 bg-gray-50 flex justify-between items-center"><h3 class="font-bold text-slate-700 text-sm">Alertas y Vencimientos</h3></div>
                        <div class="flex-1 overflow-y-auto custom-scrollbar p-4 space-y-4">
                            <div v-if="dashboardStats.alertas.length > 0">
                                <div v-for="(alerta, i) in dashboardStats.alertas" :key="'alert'+i" class="border rounded-lg p-2 mb-2 flex justify-between items-center" :class="alerta.diasRestantes < 0 ? 'bg-red-50 border-red-100' : 'bg-orange-50 border-orange-100'">
                                    <div><div class="font-bold text-xs" :class="alerta.diasRestantes < 0 ? 'text-red-800' : 'text-orange-800'">{{ alerta.matricula }}</div><div class="text-[10px]" :class="alerta.diasRestantes < 0 ? 'text-red-600' : 'text-orange-600'">{{ alerta.doc }}</div></div>
                                    <div class="text-right"><div class="text-xs font-bold" :class="alerta.diasRestantes < 0 ? 'text-red-600' : 'text-orange-600'">{{ alerta.diasRestantes < 0 ? 'Caducado' : alerta.diasRestantes + ' días' }}</div><div class="text-[9px] font-medium opacity-70">{{ new Date(alerta.fecha).toLocaleDateString('es-ES') }}</div></div>
                                </div>
                            </div>
                            <div v-else class="text-center text-green-500 py-4"><i class="fas fa-check-circle text-3xl mb-2"></i><div class="text-xs font-bold">Todo en regla</div></div>
                        </div>
                     </div>

                     <div class="bg-white rounded-2xl shadow-sm border border-gray-100 flex flex-col overflow-hidden relative h-64 md:h-auto">
                        <div class="p-3 border-b border-gray-100 bg-indigo-50 flex justify-between items-center"><h3 class="font-bold text-indigo-800 text-sm"><i class="fas fa-calendar-check mr-2"></i>Citas Chóferes</h3><span class="bg-indigo-200 text-indigo-800 text-[10px] px-2 py-0.5 rounded-full font-bold">{{ citasPendientes.length }}</span></div>
                        <div class="p-3 border-b border-gray-100 bg-gray-50/50 space-y-2">
                            <div class="flex gap-2"><select v-model="nuevaCita.choferId" class="flex-1 text-xs border border-gray-200 rounded p-1.5 outline-none focus:border-indigo-400 bg-white"><option value="">Seleccionar Chófer...</option><option v-for="c in choferes" :value="c.id">{{ c.nombre }} {{ c.apellidos }}</option></select><input type="date" v-model="nuevaCita.fecha" class="w-24 text-xs border border-gray-200 rounded p-1.5 outline-none bg-white"></div>
                            <div class="flex gap-2"><input v-model="nuevaCita.motivo" placeholder="Motivo" class="flex-1 text-xs border border-gray-200 rounded p-1.5 outline-none focus:border-indigo-400 bg-white"><button @click="agregarCita" class="bg-indigo-600 hover:bg-indigo-700 text-white px-3 py-1 rounded text-xs font-bold transition"><i class="fas fa-plus"></i></button></div>
                        </div>
                        <div class="flex-1 overflow-y-auto custom-scrollbar p-3 space-y-2">
                            <div v-if="citasPendientes.length === 0" class="text-center text-gray-300 py-6 text-xs italic">Sin citas pendientes</div>
                            <div v-for="cita in citasPendientes" :key="cita.id" class="group flex items-start gap-2 p-2 rounded-lg border border-gray-100 hover:bg-indigo-50/50 transition bg-white">
                                <div class="flex-col text-center w-10 bg-indigo-100/50 rounded p-1 text-indigo-600"><div class="text-[10px] font-bold uppercase">{{ new Date(cita.fecha).toLocaleDateString('es-ES', {month:'short'}) }}</div><div class="text-sm font-extrabold leading-none">{{ new Date(cita.fecha).getDate() }}</div></div>
                                <div class="flex-1 overflow-hidden"><div class="text-xs font-bold text-slate-700 truncate">{{ obtenerChoferData(cita.choferId, 'nombre') }} {{ obtenerChoferData(cita.choferId, 'apellidos') }}</div><div class="text-[10px] text-slate-500 truncate">{{ cita.motivo }}</div></div>
                                <button @click="borrarCita(cita.id)" class="text-gray-300 hover:text-red-500 transition opacity-100 group-hover:opacity-100"><i class="fas fa-times-circle"></i></button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div v-if="vistaActual === 'diario'" class="p-4 md:p-6 h-full flex flex-col">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4 md:mb-6 gap-2">
                    <div><h3 class="text-xl md:text-2xl font-bold text-slate-800">{{ new Date(fechaDiario).toLocaleDateString('es-ES', {weekday:'long', day:'numeric', month:'long'}).toUpperCase() }}</h3><p class="text-slate-500 text-sm">{{ viajesDiario.length }} Viajes programados</p></div>
                </div>
                <div v-if="viajesDiario.length === 0" class="flex-1 flex flex-col items-center justify-center text-slate-300"><i class="fas fa-truck-plane text-6xl mb-4 opacity-50"></i><p class="text-lg font-medium">No hay viajes registrados.</p></div>
                <div v-else class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 2xl:grid-cols-4 gap-4 md:gap-6 pb-20">
                    <div v-for="viaje in viajesDiario" :key="viaje.id" class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden flex flex-col card-hover relative group">
                        <div class="h-2 w-full" :style="{ backgroundColor: viaje.color || '#3b82f6' }"></div>
                        <div class="p-5 flex-1 flex flex-col">
                            <div class="flex justify-between items-start mb-4"><div class="bg-slate-50 rounded-lg px-3 py-1.5 border border-slate-100 inline-block max-w-[80%]"><span class="text-xs font-extrabold text-slate-700 tracking-wider uppercase truncate block">{{ viaje.rutaNombreManual || viaje.rutaNombre }}</span></div><button @click="editarViaje(viaje)" class="text-slate-300 hover:text-blue-500 transition"><i class="fas fa-pencil"></i></button></div>
                            <div class="space-y-4 flex-1">
                                <div class="flex items-center gap-3"><div class="w-8 h-8 rounded-full bg-blue-50 flex items-center justify-center text-blue-600 text-xs flex-none"><i class="fas fa-truck"></i></div><div><div class="text-sm font-bold text-slate-800">{{ viaje.tractoraPlaca }}</div><div class="text-xs text-slate-500 font-medium">{{ viaje.remolquePlaca }}</div></div></div>
                                <div class="flex items-center gap-3"><div class="w-8 h-8 rounded-full bg-emerald-50 flex items-center justify-center text-emerald-600 text-xs flex-none"><i class="fas fa-user"></i></div><div class="overflow-hidden"><div class="text-sm font-bold text-slate-800 truncate">{{ viaje.choferNombre }}</div><div class="text-[10px] text-slate-400 flex items-center" v-if="obtenerChoferData(viaje.choferId, 'telefono')"><i class="fas fa-phone mr-1 text-[9px]"></i> {{ obtenerChoferData(viaje.choferId, 'telefono') }}</div></div></div>
                                <div v-if="viaje.chofer2Id" class="flex items-center gap-3"><div class="w-8 h-8 rounded-full bg-purple-50 flex items-center justify-center text-purple-600 text-xs flex-none"><i class="fas fa-user-plus"></i></div><div class="overflow-hidden"><div class="text-sm font-bold text-slate-800 truncate">{{ viaje.chofer2Nombre }}</div><div class="text-[10px] text-slate-400 flex items-center" v-if="obtenerChoferData(viaje.chofer2Id, 'telefono')"><i class="fas fa-phone mr-1 text-[9px]"></i> {{ obtenerChoferData(viaje.chofer2Id, 'telefono') }}</div></div></div>
                            </div>
                        </div>
                        <div class="p-3 bg-gray-50 border-t border-gray-100"><button @click="copiarOrdenPortapapeles(viaje)" class="w-full bg-white hover:bg-emerald-50 text-slate-600 hover:text-emerald-700 border border-gray-200 hover:border-emerald-200 font-bold py-2.5 rounded-xl transition-all shadow-sm active:scale-95 flex items-center justify-center gap-2"><i class="far fa-copy"></i> <span class="text-xs md:text-sm">Copiar Orden</span></button></div>
                    </div>
                </div>
            </div>

            <div v-if="vistaActual === 'calendario'" class="flex flex-col h-full bg-white">
                <div class="flex justify-between items-center p-4 border-b bg-white flex-none shadow-sm z-10" v-if="calendarView !== 'list'">
                    <div class="flex items-center gap-4">
                        <div class="flex items-center bg-gray-100 rounded-lg p-0.5 shadow-inner">
                             <button @click="cambiarMes(-1)" class="w-8 h-8 flex items-center justify-center hover:bg-white rounded-md text-gray-600"><i class="fas fa-chevron-left"></i></button>
                             <button @click="irHoy" class="text-xs font-bold text-blue-600 px-3 hover:underline uppercase tracking-wider hidden md:block">Hoy</button>
                             <button @click="cambiarMes(1)" class="w-8 h-8 flex items-center justify-center hover:bg-white rounded-md text-gray-600"><i class="fas fa-chevron-right"></i></button>
                        </div>
                        <h2 class="text-lg md:text-xl font-bold text-slate-800 capitalize">{{ nombreMesActual }}</h2>
                    </div>
                </div>
                <div v-if="calendarView !== 'list'" class="flex-1 flex flex-col overflow-hidden bg-white z-0">
                    <div class="flex-1 flex flex-col overflow-auto custom-scrollbar">
                        <div class="grid grid-cols-7 border-b bg-gray-50/80 flex-none min-w-[600px] md:min-w-0"><div v-for="dia in ['Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb', 'Dom']" class="py-3 text-center text-xs font-bold text-slate-500 uppercase">{{ dia }}</div></div>
                        <div class="grid grid-cols-7 flex-1 auto-rows-fr border-l bg-gray-100/50 relative min-w-[600px] md:min-w-0">
                            <div v-for="n in paddingDias" :key="'pad-'+n" class="bg-gray-50/40 border-b border-r border-gray-200/80"></div>
                            <div v-for="dia in diasDelMes" :key="dia.fecha" @click.self="abrirModalViaje(dia.fechaStr)" class="border-b border-r border-gray-200/80 px-1 py-1 md:px-2 md:py-2 relative transition-all cursor-pointer hover:bg-blue-50/30 z-10 bg-white flex flex-col h-32 md:h-full overflow-hidden" :class="esHoy(dia.fechaStr) ? 'bg-blue-50/20' : ''">
                                <div class="text-right mb-1 md:mb-2 flex-none"><span :class="esHoy(dia.fechaStr) ? 'bg-blue-600 text-white shadow-md' : 'text-slate-400'" class="rounded-full w-5 h-5 md:w-6 md:h-6 inline-flex items-center justify-center text-[10px] md:text-xs font-bold">{{ dia.numero }}</span></div>
                                <div class="flex-1 space-y-1 overflow-y-auto custom-scrollbar pr-1 pb-1">
                                    <div v-for="viaje in filtrarViajesCalendario(dia.fechaStr)" :key="viaje.id" @click.stop="editarViaje(viaje)" class="relative rounded border border-gray-100 border-l-[3px] shadow-sm hover:shadow-md hover:scale-[1.02] transition-all cursor-pointer mb-1 p-1 group" :style="{ borderLeftColor: viaje.color || '#bae6fd', backgroundColor: hexToRgba(viaje.color || '#bae6fd', 0.15) }">
                                        <div class="text-[8px] font-black uppercase text-slate-700 truncate mb-0.5">{{ viaje.rutaNombreManual || viaje.rutaNombre }}</div>
                                        <div class="hidden md:flex items-center gap-1 flex-wrap"><div class="flex items-center bg-white/60 rounded-sm px-1 py-0.5 border border-black/5 max-w-[48%] overflow-hidden"><i class="fas fa-steering-wheel text-[7px] text-slate-500 mr-0.5 flex-none"></i><span class="text-[8px] font-bold text-slate-700 truncate leading-none">{{ viaje.choferNombre.split(' ')[0] }}</span></div></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div v-else class="flex-1 overflow-auto bg-gray-50 p-4 md:p-6 custom-scrollbar">
                    <div class="max-w-4xl mx-auto bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden">
                        <div class="bg-gray-50 border-b p-4 text-center"><h3 class="font-bold text-slate-700 text-sm md:text-base">Agenda: {{ formatDate(filtrosCalendario.customStart) }} - {{ formatDate(filtrosCalendario.customEnd) }}</h3></div>
                        <div class="divide-y divide-gray-100">
                            <div v-for="dia in diasRango" :key="dia.fecha" class="flex flex-col md:flex-row group hover:bg-blue-50/30 transition-colors">
                                <div class="w-full md:w-32 flex-none p-2 md:p-4 border-b md:border-b-0 md:border-r bg-gray-50/50 flex flex-row md:flex-col justify-between md:justify-center items-center text-center"><div class="text-xs font-bold uppercase text-slate-400 mb-0 md:mb-1">{{ dia.diaSemana }}</div><div class="text-lg md:text-2xl font-extrabold text-slate-700">{{ dia.numero }} <span class="md:hidden text-xs font-normal text-slate-500">{{ dia.mes }}</span></div><div class="hidden md:block text-xs font-medium text-slate-500">{{ dia.mes }}</div></div>
                                <div class="flex-1 p-3 md:p-4 space-y-3">
                                    <div v-if="dia.viajes.length === 0" class="text-xs text-gray-400 italic py-2">Sin actividad</div>
                                    <div v-for="viaje in dia.viajes" :key="viaje.id" @click="editarViaje(viaje)" class="flex items-center bg-white border border-gray-200 rounded-xl p-3 shadow-sm hover:shadow-md transition cursor-pointer hover:border-blue-300 relative overflow-hidden">
                                        <div class="absolute left-0 top-0 bottom-0 w-2" :style="{ backgroundColor: viaje.color || '#bae6fd' }"></div>
                                        <div class="pl-4 flex-1 grid grid-cols-1 md:grid-cols-4 gap-2 md:gap-4 items-center">
                                            <div class="md:col-span-1"><div class="text-xs font-bold text-gray-400 uppercase mb-0.5">Ruta</div><div class="text-sm font-bold text-slate-800 truncate">{{ viaje.rutaNombreManual || viaje.rutaNombre }}</div><div class="text-xs text-slate-500 mt-1">{{ viaje.horaSalida }} - {{ viaje.horaLlegada }}</div></div>
                                            <div class="md:col-span-1"><div class="text-xs font-bold text-gray-400 uppercase mb-0.5">Vehículos</div><div class="flex flex-row md:flex-col gap-3 md:gap-1"><div class="flex items-center text-xs font-bold text-slate-700 truncate"><i class="fas fa-truck text-blue-500 text-[10px] mr-1"></i> {{ viaje.tractoraPlaca }}</div><div class="flex items-center text-xs font-medium text-slate-500 truncate"><i class="fas fa-trailer text-orange-500 text-[10px] mr-1"></i> {{ viaje.remolquePlaca }}</div></div></div>
                                            <div class="md:col-span-2"><div class="text-xs font-bold text-gray-400 uppercase mb-0.5">Equipo</div><div class="flex flex-wrap gap-2"><span class="bg-blue-50 text-blue-700 px-2 py-1 rounded text-xs font-bold flex items-center"><i class="fas fa-user mr-1.5"></i>{{ viaje.choferNombre }}</span><span v-if="viaje.chofer2Nombre" class="bg-purple-50 text-purple-700 px-2 py-1 rounded text-xs font-bold flex items-center"><i class="fas fa-user-plus mr-1.5"></i>{{ viaje.chofer2Nombre }}</span></div></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div v-if="vistaActual === 'contabilidad'" class="flex flex-col h-full bg-gray-50 overflow-hidden">
                <div class="m-4 md:m-6 mb-4 bg-white p-4 md:p-5 rounded-2xl shadow-sm border border-gray-100 z-30">
                    <div class="flex flex-col md:flex-row flex-wrap gap-4 items-start md:items-end">
                        <div class="flex gap-4 w-full md:w-auto"><div class="space-y-1 flex-1"><label class="block text-xs font-bold text-slate-500 uppercase tracking-wider">Desde</label><input type="date" v-model="filtrosContabilidad.desde" class="block w-full text-sm border-gray-300 rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-200 bg-gray-50 px-3 py-2 outline-none"></div><div class="space-y-1 flex-1"><label class="block text-xs font-bold text-slate-500 uppercase tracking-wider">Hasta</label><input type="date" v-model="filtrosContabilidad.hasta" class="block w-full text-sm border-gray-300 rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-200 bg-gray-50 px-3 py-2 outline-none"></div></div>
                        <div class="space-y-1 relative w-full md:w-auto">
                            <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider">Filtrar Rutas</label>
                            <button @click="mostrarDropdownRutasAnalisis = !mostrarDropdownRutasAnalisis" class="block w-full md:w-56 text-left text-sm border border-gray-300 rounded-lg shadow-sm bg-gray-50 px-3 py-2 outline-none hover:bg-white transition flex justify-between items-center relative z-20"><span class="truncate">{{ rutasAnalisisSeleccionadas.length === 0 ? 'Todas las rutas' : rutasAnalisisSeleccionadas.length + ' seleccionadas' }}</span><i class="fas fa-chevron-down text-xs text-gray-400"></i></button>
                            <div v-if="mostrarDropdownRutasAnalisis" class="absolute left-0 top-full mt-2 w-64 bg-white rounded-xl shadow-xl border border-gray-100 overflow-hidden z-30"><div class="p-2 bg-gray-50 border-b flex justify-between items-center"><span class="text-xs font-bold text-gray-500">Seleccionar</span><button @click="rutasAnalisisSeleccionadas = []" class="text-xs text-blue-600 hover:underline">Limpiar</button></div><div class="max-h-60 overflow-y-auto p-2 custom-scrollbar"><div v-for="r in rutas" :key="r.id" class="flex items-center p-2 hover:bg-blue-50 rounded cursor-pointer" @click="toggleRutaAnalisis(r.id)"><div class="checkbox-wrapper relative w-4 h-4 mr-3"><input type="checkbox" :value="r.id" v-model="rutasAnalisisSeleccionadas" class="opacity-0 absolute inset-0 cursor-pointer z-10"><div class="w-4 h-4 border rounded bg-white border-gray-300 absolute pointer-events-none"></div></div><span class="text-sm text-slate-700 truncate">{{ r.nombre }}</span></div></div></div>
                            <div v-if="mostrarDropdownRutasAnalisis" @click="mostrarDropdownRutasAnalisis = false" class="fixed inset-0 z-10"></div>
                        </div>
                        <div class="flex-1 flex justify-between md:justify-end items-center gap-4 md:ml-auto md:border-l md:pl-6 w-full md:w-auto border-t md:border-t-0 pt-4 md:pt-0"><div class="text-right w-full"><div class="text-xs text-emerald-600 font-bold uppercase mb-1">Total Ingresos</div><div class="text-2xl font-extrabold text-emerald-700">{{ formatMoney(resumenContabilidad.granTotal) }}</div></div></div>
                    </div>
                </div>
                <div class="flex-1 overflow-auto px-4 md:px-6 pb-6 custom-scrollbar space-y-6">
                    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-4 md:p-6 relative"><h3 class="text-lg font-bold text-slate-800 mb-4"><i class="fas fa-chart-bar mr-2 text-blue-500"></i> Rendimiento</h3><div class="h-64 w-full relative"><canvas id="revenueChart"></canvas></div></div>
                    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                        <div class="p-4 border-b bg-gray-50/50 font-bold text-slate-700 text-sm">Facturación por Conductor</div>
                        <div class="overflow-x-auto"><table class="w-full text-left"><thead class="bg-gray-50/50 border-b border-gray-200"><tr><th class="pl-6 py-3 whitespace-nowrap">Conductor</th><th class="text-right py-3 whitespace-nowrap">Viajes</th><th class="text-right pr-6 py-3 whitespace-nowrap">Total</th></tr></thead><tbody class="divide-y divide-gray-100"><tr v-for="c in resumenContabilidad.desgloseChoferes" :key="c.id" class="hover:bg-blue-50/30"><td class="pl-6 py-3 font-medium text-slate-800 whitespace-nowrap">{{ c.nombre }}</td><td class="text-right py-3 text-slate-600">{{ c.viajes }}</td><td class="text-right pr-6 py-3 font-bold text-emerald-600 whitespace-nowrap">{{ formatMoney(c.total) }}</td></tr></tbody></table></div>
                    </div>
                </div>
            </div>

            <div v-if="vistaActual === 'analisisChofer'" class="flex flex-col h-full bg-gray-50 overflow-hidden">
                <div class="m-4 md:m-6 mb-4 bg-white p-4 md:p-5 rounded-2xl shadow-sm border border-gray-100 z-30">
                    <div class="flex flex-col md:flex-row flex-wrap gap-4 items-end justify-between">
                         <div class="flex gap-4 items-end w-full md:w-auto"><div class="space-y-1 flex-1"><label class="block text-xs font-bold text-slate-500 uppercase tracking-wider">Desde</label><input type="date" v-model="filtrosChofer.desde" class="block w-full text-sm border-gray-300 rounded-lg shadow-sm bg-gray-50 px-3 py-2 outline-none"></div><div class="space-y-1 flex-1"><label class="block text-xs font-bold text-slate-500 uppercase tracking-wider">Hasta</label><input type="date" v-model="filtrosChofer.hasta" class="block w-full text-sm border-gray-300 rounded-lg shadow-sm bg-gray-50 px-3 py-2 outline-none"></div></div>
                         <div class="bg-gray-100 p-1 rounded-xl flex shadow-inner border border-gray-200 w-full md:w-auto overflow-x-auto">
                             <button @click="metricChofer = 'viajes'" :class="metricChofer === 'viajes' ? 'active' : 'text-slate-500 hover:text-slate-700'" class="toggle-btn flex-1 md:flex-none px-4 py-2 rounded-lg text-xs font-medium whitespace-nowrap">Viajes</button>
                             <button @click="metricChofer = 'fuera_casa'" :class="metricChofer === 'fuera_casa' ? 'active' : 'text-slate-500 hover:text-slate-700'" class="toggle-btn flex-1 md:flex-none px-4 py-2 rounded-lg text-xs font-medium whitespace-nowrap">H. Fuera</button>
                             <button @click="metricChofer = 'revenue'" :class="metricChofer === 'revenue' ? 'active' : 'text-slate-500 hover:text-slate-700'" class="toggle-btn flex-1 md:flex-none px-4 py-2 rounded-lg text-xs font-medium text-emerald-600 whitespace-nowrap">Facturación €</button>
                        </div>
                    </div>
                </div>
                <div class="flex-1 overflow-auto px-4 md:px-6 pb-6 custom-scrollbar space-y-6">
                    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                        <div class="p-4 border-b bg-slate-50/50 flex justify-between items-center"><h3 class="font-bold text-slate-700 text-sm">Resumen</h3></div>
                        <div class="overflow-x-auto"><table class="w-full text-left text-sm"><thead class="bg-slate-50 text-xs text-slate-500 uppercase border-b"><tr><th class="px-6 py-3 font-semibold whitespace-nowrap">Chófer</th><th class="px-6 py-3 text-center font-semibold">Viajes</th><th class="px-6 py-3 text-center font-semibold text-emerald-600 whitespace-nowrap">Facturación</th><th class="px-6 py-3 text-center font-semibold text-blue-600 whitespace-nowrap">H. Fuera</th><th class="px-6 py-3 text-center font-semibold text-slate-600 whitespace-nowrap">H. Casa</th><th class="px-6 py-3 text-center font-semibold">% Casa</th></tr></thead>
                            <tbody class="divide-y divide-gray-100"><tr v-for="c in resumenChoferes.lista" :key="c.id" class="hover:bg-slate-50/50 transition"><td class="px-6 py-4 whitespace-nowrap"><div class="flex flex-col"><div class="flex items-center"><div class="w-8 h-8 rounded-full bg-slate-200 text-slate-600 text-[10px] flex items-center justify-center font-bold mr-3">{{ c.nombre.substring(0,2) }}</div><span class="font-bold text-slate-700">{{ c.nombre }}</span></div></div></td><td class="px-6 py-4 text-center"><span class="bg-slate-100 text-slate-700 py-1 px-3 rounded-full text-xs font-bold">{{ c.viajes }}</span></td><td class="px-6 py-4 text-center font-mono font-bold text-emerald-600 whitespace-nowrap">{{ formatMoney(c.revenue) }}</td><td class="px-6 py-4 text-center"><span class="font-bold text-blue-600">{{ formatHours(c.horas) }}</span></td><td class="px-6 py-4 text-center"><span class="font-bold text-slate-500">{{ formatHours(c.horasCasa) }}</span></td>
                                <td class="px-6 py-4 text-center"><div class="relative w-10 h-10 mx-auto"><svg class="circular-chart" viewBox="0 0 36 36"><path class="circle-bg" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" /><path class="circle text-emerald-500" :stroke-dasharray="getHomePercent(c) + ', 100'" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" /></svg><div class="absolute inset-0 flex items-center justify-center text-[8px] font-bold text-emerald-700">{{ getHomePercent(c) }}%</div></div></td></tr></tbody></table></div>
                    </div>
                    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-4 md:p-6 relative"><h3 class="text-lg font-bold text-slate-800 mb-4 flex items-center">{{ metricChofer === 'viajes' ? 'Número de Viajes' : (metricChofer === 'fuera_casa' ? 'Horas Fuera de Casa' : 'Facturación Generada (€)') }}</h3><div class="h-64 w-full relative"><canvas id="driverChart"></canvas></div></div>
                </div>
            </div>

            <div v-if="vistaActual === 'flota'" class="flex flex-col h-full bg-gray-50 overflow-y-auto custom-scrollbar">
                <div class="p-4 md:p-6 max-w-7xl mx-auto space-y-4 md:space-y-6 w-full">
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 flex items-center justify-between">
                            <div><div class="text-xs font-bold text-blue-600 uppercase tracking-wider">En Ruta</div><div class="text-3xl font-extrabold text-slate-800 mt-1">{{ analisisFlota.tractoras.filter(t => t.status === 'active').length }} / {{ tractoras.length }}</div></div>
                            <div class="w-12 h-12 bg-blue-50 rounded-full flex items-center justify-center text-blue-600 text-xl"><i class="fas fa-truck-moving"></i></div>
                        </div>
                        <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 flex items-center justify-between">
                            <div><div class="text-xs font-bold text-red-600 uppercase tracking-wider">En Avería</div><div class="text-3xl font-extrabold text-red-600 mt-1">{{ averiasActivas.length }}</div></div>
                            <div class="w-12 h-12 bg-red-50 rounded-full flex items-center justify-center text-red-600 text-xl"><i class="fas fa-tools"></i></div>
                        </div>
                        <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 flex items-center justify-between">
                            <div><div class="text-xs font-bold text-emerald-600 uppercase tracking-wider">Disponibles</div><div class="text-3xl font-extrabold text-emerald-600 mt-1">{{ tractoras.length - analisisFlota.tractoras.filter(t => t.status === 'active').length - vehiculosEnAveria.tractoras.length }}</div></div>
                            <div class="w-12 h-12 bg-emerald-50 rounded-full flex items-center justify-center text-emerald-600 text-xl"><i class="fas fa-check-circle"></i></div>
                        </div>
                    </div>

                    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                        <div class="p-4 border-b bg-red-50 flex justify-between items-center">
                            <h3 class="font-bold text-red-800"><i class="fas fa-exclamation-triangle mr-2"></i>Histórico y Gestión de Averías</h3>
                            <button @click="mostrarModalAveria = true" class="bg-red-600 hover:bg-red-700 text-white text-xs font-bold py-2 px-4 rounded-lg shadow flex items-center">
                                <i class="fas fa-plus mr-2"></i> Registrar Avería
                            </button>
                        </div>
                        
                        <div class="p-3 bg-gray-100/50 border-b flex flex-wrap gap-3 items-center">
                            <div class="flex items-center gap-2">
                                <label class="text-[10px] font-bold uppercase text-slate-500">Filtrar:</label>
                                <select v-model="filtrosAverias.vehiculoId" class="text-xs border border-gray-200 rounded-lg p-1.5 outline-none bg-white w-32 md:w-48">
                                    <option value="">Todos los vehículos</option>
                                    <optgroup label="Tractoras">
                                        <option v-for="t in tractoras" :value="t.matricula">{{ t.matricula }}</option>
                                    </optgroup>
                                    <optgroup label="Remolques">
                                        <option v-for="r in remolques" :value="r.matricula">{{ r.matricula }}</option>
                                    </optgroup>
                                </select>
                            </div>
                            <div class="flex items-center gap-2">
                                <label class="text-[10px] font-bold uppercase text-slate-500">Desde:</label>
                                <input type="date" v-model="filtrosAverias.desde" class="text-xs border border-gray-200 rounded-lg p-1.5 outline-none bg-white">
                            </div>
                            <div class="flex items-center gap-2">
                                <label class="text-[10px] font-bold uppercase text-slate-500">Hasta:</label>
                                <input type="date" v-model="filtrosAverias.hasta" class="text-xs border border-gray-200 rounded-lg p-1.5 outline-none bg-white">
                            </div>
                            <button @click="limpiarFiltrosAverias" class="text-xs text-blue-600 font-bold hover:underline ml-auto">Limpiar filtros</button>
                        </div>

                        <div class="divide-y divide-gray-100 max-h-[400px] overflow-y-auto custom-scrollbar">
                            <div v-if="averiasFiltradas.length === 0" class="p-8 text-center text-gray-400">
                                <i class="fas fa-search text-4xl mb-2 opacity-50"></i>
                                <div class="text-sm">No se encontraron averías con estos filtros</div>
                            </div>
                            <div v-for="averia in averiasFiltradas" :key="averia.id" class="p-4 flex flex-col md:flex-row justify-between items-start md:items-center gap-3 hover:bg-gray-50/50 transition border-l-4" :class="averia.estado === 'activa' ? 'border-l-red-500 bg-red-50/10' : 'border-l-green-500'">
                                <div class="flex items-center gap-3 flex-1">
                                    <div class="w-10 h-10 rounded-full flex items-center justify-center text-sm flex-none" :class="averia.estado === 'activa' ? 'bg-red-100 text-red-600' : 'bg-green-100 text-green-600'">
                                        <i :class="averia.estado === 'activa' ? 'fas fa-wrench' : 'fas fa-check'"></i>
                                    </div>
                                    <div class="flex-1 overflow-hidden">
                                        <div class="font-bold text-slate-800">{{ averia.vehiculoMatricula }} <span class="text-xs font-normal text-gray-500">({{ averia.tipoVehiculo }})</span></div>
                                        <div class="text-sm text-slate-600 truncate">{{ averia.descripcion }}</div>
                                    </div>
                                </div>
                                <div class="flex items-center gap-4 text-sm">
                                    <div class="text-center">
                                        <div class="text-[10px] text-gray-400 uppercase">Inicio</div>
                                        <div class="font-bold text-slate-700">{{ formatDate(averia.fechaInicio) }}</div>
                                    </div>
                                    <div class="text-center">
                                        <div class="text-[10px] text-gray-400 uppercase">Fin</div>
                                        <div class="font-bold" :class="averia.fechaFin ? 'text-green-600' : 'text-red-600'">{{ averia.fechaFin ? formatDate(averia.fechaFin) : 'Activa' }}</div>
                                    </div>
                                    <div class="text-center min-w-[60px]">
                                        <div class="text-[10px] text-gray-400 uppercase">Duración</div>
                                        <div class="font-bold" :class="averia.estado === 'activa' ? 'text-red-600' : 'text-slate-700'">{{ calcularDiasAveria(averia) }} días</div>
                                    </div>
                                    <div class="flex gap-2">
                                        <button v-if="averia.estado === 'activa'" @click="resolverAveria(averia.id)" class="bg-green-100 hover:bg-green-200 text-green-700 px-2 py-1.5 rounded text-xs font-bold" title="Marcar como resuelta hoy">
                                            <i class="fas fa-check"></i>
                                        </button>
                                        <button @click="abrirEditarAveria(averia)" class="bg-blue-100 hover:bg-blue-200 text-blue-700 px-2 py-1.5 rounded text-xs font-bold" title="Editar fechas/datos">
                                            <i class="fas fa-pencil"></i>
                                        </button>
                                        <button @click="eliminarAveria(averia.id)" class="bg-gray-100 hover:bg-red-100 text-gray-500 hover:text-red-600 px-2 py-1.5 rounded text-xs font-bold" title="Eliminar registro">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-4 md:p-6">
                        <h3 class="font-bold text-slate-800 mb-4"><i class="fas fa-chart-bar mr-2 text-red-500"></i>Tiempo de Averías por Vehículo</h3>
                        <div class="h-64 w-full relative"><canvas id="averiasChart"></canvas></div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="bg-white rounded-2xl shadow-sm border border-gray-100 flex flex-col overflow-hidden h-96 md:h-[500px]">
                            <div class="p-4 border-b bg-gray-50 font-bold text-slate-700 flex justify-between items-center"><span><i class="fas fa-truck-moving text-blue-500 mr-2"></i> Tractoras</span></div>
                            <div class="flex-1 overflow-y-auto custom-scrollbar p-3 space-y-3">
                                <div v-for="t in analisisFlota.tractoras" :key="t.id" class="border rounded-xl p-3" :class="getVehiculoClass(t, 'tractora')">
                                    <div class="flex justify-between items-start">
                                        <div>
                                            <div class="font-bold text-slate-800">{{ t.matricula }} <span class="text-xs text-gray-400 font-normal">{{ t.modelo }}</span></div>
                                            <div v-if="t.status === 'active'" class="text-xs text-blue-600 font-bold mt-1"><i class="fas fa-road mr-1"></i>En Ruta</div>
                                            <div v-else-if="estaEnAveria(t.id, 'tractora')" class="text-xs text-red-600 font-bold mt-1"><i class="fas fa-tools mr-1"></i>En Avería</div>
                                            <div v-else class="text-xs text-slate-400 mt-1"><i class="fas fa-parking mr-1"></i>Disponible</div>
                                        </div>
                                        <div v-if="estaEnAveria(t.id, 'tractora')" class="bg-red-100 text-red-700 text-[10px] px-2 py-1 rounded-full font-bold">
                                            {{ calcularDiasAveria(getAveriaActiva(t.id, 'tractora')) }}d
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white rounded-2xl shadow-sm border border-gray-100 flex flex-col overflow-hidden h-96 md:h-[500px]">
                            <div class="p-4 border-b bg-gray-50 font-bold text-slate-700 flex justify-between items-center"><span><i class="fas fa-trailer text-orange-500 mr-2"></i> Remolques</span></div>
                            <div class="flex-1 overflow-y-auto custom-scrollbar p-3 space-y-3">
                                <div v-for="r in analisisFlota.remolques" :key="r.id" class="border rounded-xl p-3" :class="getVehiculoClass(r, 'remolque')">
                                    <div class="flex justify-between items-start">
                                        <div>
                                            <div class="font-bold text-slate-800">{{ r.matricula }} <span class="text-xs text-gray-400 font-normal">{{ r.tipo }}</span></div>
                                            <div v-if="r.status === 'active'" class="text-xs text-orange-600 font-bold mt-1"><i class="fas fa-road mr-1"></i>En Ruta</div>
                                            <div v-else-if="estaEnAveria(r.id, 'remolque')" class="text-xs text-red-600 font-bold mt-1"><i class="fas fa-tools mr-1"></i>En Avería</div>
                                            <div v-else class="text-xs text-slate-400 mt-1"><i class="fas fa-parking mr-1"></i>Disponible</div>
                                        </div>
                                        <div v-if="estaEnAveria(r.id, 'remolque')" class="bg-red-100 text-red-700 text-[10px] px-2 py-1 rounded-full font-bold">
                                            {{ calcularDiasAveria(getAveriaActiva(r.id, 'remolque')) }}d
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div v-if="vistaActual === 'admin'" class="p-4 md:p-6 max-w-[1600px] mx-auto h-full flex flex-col">
                <div class="bg-slate-800 text-white p-5 rounded-2xl shadow-md mb-6 md:mb-8 flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                    <div><h3 class="text-lg font-bold">Datos</h3><p class="text-slate-400 text-sm">Backup del sistema</p></div>
                    <div class="flex gap-2 w-full md:w-auto"><button @click="descargarCopia" class="flex-1 md:flex-none bg-blue-600 px-4 py-2 rounded font-bold text-sm">Descargar</button><label class="flex-1 md:flex-none bg-emerald-600 px-4 py-2 rounded font-bold cursor-pointer text-sm text-center">Restaurar<input type="file" @change="restaurarCopia" class="hidden" accept=".json"></label></div>
                </div>
                
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-6 overflow-y-auto custom-scrollbar pb-24 md:pb-0">
                    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 flex flex-col h-96 md:h-full overflow-hidden">
                        <div class="p-4 border-b bg-purple-50 flex justify-between font-bold text-purple-800"><span>Chóferes</span><button @click="abrirAdmin('chofer')" class="text-xs bg-purple-200 px-2 py-1 rounded">+ Añadir</button></div>
                        <ul class="overflow-y-auto p-3 space-y-2 flex-1">
                            <li v-for="c in choferes" class="flex justify-between p-2 bg-gray-50 rounded border items-center group"><div class="overflow-hidden"><div class="truncate font-bold text-slate-700">{{ getFullDriverName(c) }}</div><div class="flex items-center text-[10px] text-gray-500 gap-2"><span v-if="c.tipoId" class="bg-gray-100 px-1.5 py-0.5 rounded border">{{ getTipoChoferNombre(c.tipoId) }}</span><span v-if="c.telefono"><i class="fas fa-phone mr-1"></i>{{c.telefono}}</span></div></div><div class="flex gap-2 flex-none"><button @click="editarAdmin('chofer', c)" class="text-blue-400"><i class="fas fa-pencil"></i></button><button @click="eliminarItem('chofer', c.id)" class="text-red-400"><i class="fas fa-trash"></i></button></div></li>
                        </ul>
                    </div>
                    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 flex flex-col h-64 md:h-full overflow-hidden">
                        <div class="p-4 border-b bg-pink-50 flex justify-between font-bold text-pink-800"><span>Tipos Chófer</span><button @click="abrirAdmin('tipoChofer')" class="text-xs bg-pink-200 px-2 py-1 rounded">+ Añadir</button></div>
                        <ul class="overflow-y-auto p-3 space-y-2 flex-1"><li v-if="tiposChofer.length === 0" class="text-xs text-gray-400 text-center py-4">Sin tipos definidos</li><li v-for="tc in tiposChofer" :key="tc.id" class="flex justify-between p-2 bg-gray-50 rounded border items-center"><div class="font-bold text-slate-700 text-sm truncate">{{ tc.nombre }}</div><div class="flex gap-2 flex-none"><button @click="editarAdmin('tipoChofer', tc)" class="text-blue-400"><i class="fas fa-pencil"></i></button><button @click="eliminarItem('tipoChofer', tc.id)" class="text-red-400"><i class="fas fa-trash"></i></button></div></li></ul>
                    </div>
                    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 flex flex-col h-64 md:h-full overflow-hidden"><div class="p-4 border-b bg-blue-50 flex justify-between font-bold text-blue-800"><span>Rutas</span><button @click="abrirAdmin('ruta')" class="text-xs bg-blue-200 px-2 py-1 rounded">+ Añadir</button></div><ul class="overflow-y-auto p-3 space-y-2 flex-1"><li v-for="r in rutas" class="flex justify-between p-2 bg-gray-50 rounded border"><div class="truncate">{{ r.nombre }}</div><div class="flex gap-2"><button @click="editarAdmin('ruta', r)" class="text-blue-400"><i class="fas fa-pencil"></i></button><button @click="eliminarItem('ruta', r.id)" class="text-red-400"><i class="fas fa-trash"></i></button></div></li></ul></div>
                    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 flex flex-col h-64 md:h-full overflow-hidden"><div class="p-4 border-b bg-emerald-50 flex justify-between font-bold text-emerald-800"><span>Tractoras</span><button @click="abrirAdmin('tractora')" class="text-xs bg-emerald-200 px-2 py-1 rounded">+ Añadir</button></div><ul class="overflow-y-auto p-3 space-y-2 flex-1"><li v-for="t in tractoras" class="flex justify-between p-2 bg-gray-50 rounded border items-center"><div class="flex flex-col overflow-hidden"><div class="font-bold text-slate-700 truncate text-sm">{{ t.matricula }}</div><div class="text-xs text-gray-400 truncate">{{ t.modelo }}</div></div><div class="flex gap-2 flex-none"><button @click="editarAdmin('tractora', t)" class="text-blue-400"><i class="fas fa-pencil"></i></button><button @click="eliminarItem('tractora', t.id)" class="text-red-400"><i class="fas fa-trash"></i></button></div></li></ul></div>
                    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 flex flex-col h-64 md:h-full overflow-hidden"><div class="p-4 border-b bg-orange-50 flex justify-between font-bold text-orange-800"><span>Remolques</span><button @click="abrirAdmin('remolque')" class="text-xs bg-orange-200 px-2 py-1 rounded">+ Añadir</button></div><ul class="overflow-y-auto p-3 space-y-2 flex-1"><li v-for="r in remolques" class="flex justify-between p-2 bg-gray-50 rounded border items-center"><div class="flex flex-col overflow-hidden"><div class="font-bold text-slate-700 truncate text-sm">{{ r.matricula }}</div><div class="text-xs text-gray-400 truncate">{{ r.tipo }}</div></div><div class="flex gap-2 flex-none"><button @click="editarAdmin('remolque', r)" class="text-blue-400"><i class="fas fa-pencil"></i></button><button @click="eliminarItem('remolque', r.id)" class="text-red-400"><i class="fas fa-trash"></i></button></div></li></ul></div>
                </div>
            </div>

        </div>
    </main>

    <div v-if="mostrarModalViaje" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm flex justify-center items-center z-50 p-4 transition-all">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden flex flex-col max-h-[90vh]">
            <div class="h-3 w-full flex-none" :style="{ backgroundColor: nuevoViaje.color || '#3b82f6' }"></div>
            <div class="p-4 md:p-8 overflow-y-auto custom-scrollbar">
                <h2 class="text-lg md:text-2xl font-bold mb-6 text-slate-800 flex justify-between items-center">
                    <span>{{ modoEdicion ? 'Editar' : 'Programar' }} Viaje</span>
                    <div class="flex flex-wrap gap-1.5 justify-end max-w-[150px] md:max-w-[180px] bg-gray-50 p-2 rounded-xl border border-gray-100"><button v-for="color in colores" :key="color" @click="nuevoViaje.color = color" class="w-4 h-4 md:w-5 md:h-5 rounded-full border-2 transition-all hover:scale-110 shadow-sm" :class="nuevoViaje.color === color ? 'border-slate-800 scale-110 ring-2 ring-offset-1 ring-slate-300' : 'border-transparent'" :style="{ backgroundColor: color }"></button></div>
                </h2>
                <div class="space-y-4 md:space-y-5 font-medium text-slate-600">
                    <div class="grid grid-cols-2 gap-3 md:gap-4 bg-gray-50 p-3 md:p-4 rounded-xl border border-gray-100">
                        <div class="space-y-2"><div class="text-xs font-bold text-blue-700 uppercase tracking-wider flex items-center"><i class="fas fa-plane-departure mr-1"></i> Salida</div><input type="date" v-model="nuevoViaje.fechaSalida" class="w-full border-gray-300 shadow-sm rounded-lg p-2 text-xs bg-white outline-none"><input type="time" v-model="nuevoViaje.horaSalida" class="w-full border-gray-300 shadow-sm rounded-lg p-2 text-xs bg-white outline-none"></div>
                        <div class="space-y-2"><div class="text-xs font-bold text-orange-600 uppercase tracking-wider flex items-center"><i class="fas fa-plane-arrival mr-1"></i> Llegada</div><input type="date" v-model="nuevoViaje.fechaLlegada" class="w-full border-gray-300 shadow-sm rounded-lg p-2 text-xs bg-white outline-none focus:ring-1 focus:ring-orange-200"><input type="time" v-model="nuevoViaje.horaLlegada" class="w-full border-gray-300 shadow-sm rounded-lg p-2 text-xs bg-white outline-none focus:ring-1 focus:ring-orange-200"></div>
                    </div>
                    <div class="space-y-2">
                        <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1.5">Ruta</label>
                        <select v-model="nuevoViaje.rutaId" @change="alSeleccionarRuta" class="w-full border-gray-300 shadow-sm rounded-lg p-3 text-sm bg-gray-50/50 outline-none mb-2"><option value="" disabled>Seleccionar Ruta (Estadísticas)...</option><option v-for="r in rutas" :value="r.id">{{ r.nombre }}</option></select>
                        <div class="relative"><input v-model="nuevoViaje.rutaNombreManual" placeholder="Nombre en Orden" class="w-full border border-blue-200 shadow-sm rounded-lg p-3 text-sm bg-white outline-none focus:ring-1 focus:ring-blue-400"><div class="absolute right-2 top-1/2 -translate-y-1/2 text-[10px] md:text-xs text-blue-300 font-bold pointer-events-none">ORDEN</div></div>
                    </div>
                    <div class="grid grid-cols-2 gap-4"><div><label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1.5">Conductor</label><select v-model="nuevoViaje.choferId" class="w-full border-gray-300 shadow-sm rounded-lg p-3 text-sm bg-gray-50/50 outline-none"><option value="" disabled>Seleccionar...</option><option v-for="c in choferes" :value="c.id">{{ getFullDriverName(c) }}</option></select></div><div><label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1.5">2º Conductor</label><select v-model="nuevoViaje.chofer2Id" class="w-full border-gray-300 shadow-sm rounded-lg p-3 text-sm bg-gray-50/30 outline-none"><option :value="null">-- Ninguno --</option><option v-for="c in choferes" :value="c.id">{{ getFullDriverName(c) }}</option></select></div></div>
                    <div class="grid grid-cols-2 gap-4 p-4 bg-gray-50 rounded-xl border border-gray-100"><div><label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1.5">Tractora</label><select v-model="nuevoViaje.tractoraId" class="w-full border-gray-200 shadow-sm rounded-lg p-2.5 text-sm bg-white outline-none"><option value="" disabled>...</option><option v-for="t in tractoras" :value="t.id">{{ t.matricula }}</option></select></div><div><label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1.5">Remolque</label><select v-model="nuevoViaje.remolqueId" class="w-full border-gray-200 shadow-sm rounded-lg p-2.5 text-sm bg-white outline-none"><option value="" disabled>...</option><option v-for="r in remolques" :value="r.id">{{ r.matricula }}</option></select></div></div>
                    <div class="border border-blue-100 rounded-xl overflow-hidden">
                        <div class="bg-blue-50/50 p-4">
                            <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1.5">Cargador (Opcional)</label>
                            <select v-model="nuevoViaje.cargadorId" class="w-full border-gray-300 shadow-sm rounded-lg p-3 text-sm bg-white outline-none mb-3"><option :value="null">-- Ninguno --</option><option v-for="c in choferes" :value="c.id">{{ getFullDriverName(c) }}</option></select>
                            <div v-if="nuevoViaje.cargadorId" class="grid grid-cols-2 gap-3 animate-pop"><div class="space-y-1"><div class="text-[10px] font-bold text-slate-400 uppercase">Inicio</div><input type="date" v-model="nuevoViaje.fechaSalidaCargador" class="w-full border-gray-300 shadow-sm rounded p-1.5 text-xs bg-white"><input type="time" v-model="nuevoViaje.horaSalidaCargador" class="w-full border-gray-300 shadow-sm rounded p-1.5 text-xs bg-white"></div><div class="space-y-1"><div class="text-[10px] font-bold text-slate-400 uppercase">Fin</div><input type="date" v-model="nuevoViaje.fechaLlegadaCargador" class="w-full border-gray-300 shadow-sm rounded p-1.5 text-xs bg-white"><input type="time" v-model="nuevoViaje.horaLlegadaCargador" class="w-full border-gray-300 shadow-sm rounded p-1.5 text-xs bg-white"></div></div>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-5 bg-gradient-to-br from-emerald-50 to-teal-50 p-5 rounded-2xl border border-emerald-100 shadow-inner"><div><label class="block text-xs font-bold text-blue-600 uppercase tracking-wider mb-1.5">Ida (€)</label><input type="number" v-model="nuevoViaje.precioIda" placeholder="0" class="w-full border-blue-200 p-2 rounded-xl font-bold text-blue-800 text-lg shadow-sm"></div><div><label class="block text-xs font-bold text-orange-600 uppercase tracking-wider mb-1.5">Vuelta (€)</label><input type="number" v-model="nuevoViaje.precioVuelta" placeholder="0" class="w-full border-orange-200 p-2 rounded-xl font-bold text-orange-800 text-lg shadow-sm"></div></div>
                </div>
                <div class="mt-8 flex justify-between items-center border-t pt-5"><button v-if="modoEdicion" @click="eliminarViajeActual" class="text-red-500 font-bold text-sm hover:bg-red-50 px-3 py-2 rounded transition">Eliminar</button><div v-else></div><div class="flex gap-3"><button @click="mostrarModalViaje = false" class="px-5 py-2.5 rounded-xl text-slate-600 font-bold hover:bg-gray-100 transition">Cancelar</button><button @click="guardarViaje" class="bg-slate-900 hover:bg-black text-white px-8 py-2.5 rounded-xl font-bold transition shadow-lg transform hover:-translate-y-0.5">Guardar</button></div></div>
            </div>
        </div>
    </div>

    <div v-if="modalAdmin" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm flex justify-center items-center z-50 p-4">
        <div class="bg-white p-6 md:p-8 rounded-2xl w-full max-w-md shadow-2xl">
            <h3 class="font-bold text-2xl mb-6 text-slate-800 capitalize">Admin: {{ modalAdmin === 'tipoChofer' ? 'Tipo Chófer' : modalAdmin }}</h3>
            <div class="space-y-4">
                 <div v-if="modalAdmin === 'chofer'" class="grid grid-cols-2 gap-4"><input v-model="formAdmin.nombre" placeholder="Nombre" class="border p-3 rounded-lg bg-gray-50 outline-none w-full"><input v-model="formAdmin.apellidos" placeholder="Apellidos" class="border p-3 rounded-lg bg-gray-50 outline-none w-full"></div>
                 <input v-else v-model="formAdmin.nombre" placeholder="Nombre / Descripción" class="w-full border p-3 rounded-lg bg-gray-50 outline-none">
                 <div v-if="modalAdmin === 'chofer'" class="space-y-4"><div><label class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-1 block">Tipo de Chófer</label><select v-model="formAdmin.tipoId" class="w-full border p-3 rounded-lg bg-gray-50 outline-none"><option :value="null">-- Sin clasificar --</option><option v-for="t in tiposChofer" :key="t.id" :value="t.id">{{ t.nombre }}</option></select></div><input v-model="formAdmin.datoExtra" placeholder="Licencia" class="w-full border p-3 rounded-lg bg-gray-50 outline-none"><div class="grid grid-cols-2 gap-4"><input v-model="formAdmin.dni" placeholder="DNI" class="border p-3 rounded-lg bg-gray-50 outline-none w-full"><input v-model="formAdmin.telefono" placeholder="Teléfono" class="border p-3 rounded-lg bg-gray-50 outline-none w-full"></div></div>
                 <input v-if="modalAdmin !== 'ruta' && modalAdmin !== 'chofer' && modalAdmin !== 'tipoChofer'" v-model="formAdmin.datoExtra" placeholder="Matrícula" class="w-full border p-3 rounded-lg bg-gray-50 outline-none">
                 <div v-if="modalAdmin === 'ruta'" class="space-y-4"><div class="grid grid-cols-2 gap-4"><input v-model="formAdmin.origen" placeholder="Origen" class="border p-2 rounded w-full"><input v-model="formAdmin.destino" placeholder="Destino" class="border p-2 rounded w-full"></div><input v-model="formAdmin.km" type="number" placeholder="KM" class="w-full border p-2 rounded"></div>
                 <div v-if="modalAdmin === 'tractora'" class="p-4 bg-yellow-50 rounded-xl border border-yellow-100 space-y-3"><div><label class="text-xs font-bold uppercase text-yellow-700 flex items-center"><i class="fas fa-clipboard-check mr-2"></i>ITV</label><input type="date" v-model="formAdmin.itv" class="w-full border p-2 rounded mt-1"></div><div><label class="text-xs font-bold uppercase text-purple-700 flex items-center"><i class="fas fa-tachometer-alt mr-2"></i>Tacógrafo</label><input type="date" v-model="formAdmin.tacografo" class="w-full border p-2 rounded mt-1"></div></div>
                 <div v-if="modalAdmin === 'remolque'" class="p-4 bg-yellow-50 rounded-xl border border-yellow-100 space-y-3"><div><label class="text-xs font-bold uppercase text-yellow-700 flex items-center"><i class="fas fa-clipboard-check mr-2"></i>ITV</label><input type="date" v-model="formAdmin.itv" class="w-full border p-2 rounded mt-1"></div><div><label class="text-xs font-bold uppercase text-blue-700 flex items-center"><i class="fas fa-snowflake mr-2"></i>ATP</label><input type="date" v-model="formAdmin.atp" class="w-full border p-2 rounded mt-1"></div><div><label class="text-xs font-bold uppercase text-red-700 flex items-center"><i class="fas fa-temperature-low mr-2"></i>Termógrafo</label><input type="date" v-model="formAdmin.termografo" class="w-full border p-2 rounded mt-1"></div></div>
            </div>
            <div class="mt-8 flex justify-end gap-3"><button @click="modalAdmin = null" class="px-5 py-2 rounded font-bold text-slate-500">Cancelar</button><button @click="guardarAdmin" class="bg-blue-600 text-white px-6 py-2 rounded font-bold">Guardar</button></div>
        </div>
    </div>

    <div v-if="mostrarModalAveria" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm flex justify-center items-center z-50 p-4">
        <div class="bg-white p-6 rounded-2xl w-full max-w-md shadow-2xl">
            <h3 class="font-bold text-xl mb-4 text-slate-800 border-b pb-2">Registrar Avería</h3>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Tipo de Vehículo</label>
                    <div class="flex gap-4">
                        <label class="flex-1 flex items-center justify-center gap-2 cursor-pointer bg-gray-50 p-3 rounded-xl border border-gray-200 hover:bg-blue-50 hover:border-blue-200 transition" :class="nuevaAveria.tipoVehiculo === 'tractora' ? 'ring-2 ring-blue-500 border-transparent bg-blue-50' : ''">
                            <input type="radio" v-model="nuevaAveria.tipoVehiculo" value="tractora" class="hidden">
                            <i class="fas fa-truck-moving text-blue-500"></i>
                            <span class="text-sm font-bold text-slate-700">Tractora</span>
                        </label>
                        <label class="flex-1 flex items-center justify-center gap-2 cursor-pointer bg-gray-50 p-3 rounded-xl border border-gray-200 hover:bg-orange-50 hover:border-orange-200 transition" :class="nuevaAveria.tipoVehiculo === 'remolque' ? 'ring-2 ring-orange-500 border-transparent bg-orange-50' : ''">
                            <input type="radio" v-model="nuevaAveria.tipoVehiculo" value="remolque" class="hidden">
                            <i class="fas fa-trailer text-orange-500"></i>
                            <span class="text-sm font-bold text-slate-700">Remolque</span>
                        </label>
                    </div>
                </div>

                <div v-if="nuevaAveria.tipoVehiculo" class="animate-pop">
                    <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">
                        Seleccionar {{ nuevaAveria.tipoVehiculo === 'tractora' ? 'Tractora' : 'Remolque' }}
                    </label>
                    <select v-model="nuevaAveria.vehiculoId" class="w-full border p-3 rounded-lg bg-gray-50 outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-200">
                        <option value="" disabled>-- Seleccionar --</option>
                        <option v-for="v in vehiculosDisponiblesAveria" :key="v.id" :value="v.id">
                            {{ v.matricula }} {{ v.modelo || v.tipo ? ' - ' + (v.modelo || v.tipo) : '' }}
                        </option>
                    </select>
                </div>

                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">Fecha de Inicio</label>
                    <input type="date" v-model="nuevaAveria.fechaInicio" class="w-full border p-3 rounded-lg bg-gray-50 outline-none focus:border-blue-500">
                </div>

                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">Descripción del Problema</label>
                    <textarea v-model="nuevaAveria.descripcion" rows="3" class="w-full border p-3 rounded-lg bg-gray-50 outline-none focus:border-blue-500" placeholder="Detalles de la avería..."></textarea>
                </div>
            </div>

            <div class="mt-6 flex justify-end gap-3 pt-4 border-t border-gray-100">
                <button @click="mostrarModalAveria = false" class="px-5 py-2.5 rounded-xl font-bold text-slate-500 hover:bg-gray-100 transition">Cancelar</button>
                <button @click="agregarAveria(); if(nuevaAveria.tipoVehiculo === '') mostrarModalAveria = false;" class="bg-red-600 hover:bg-red-700 text-white px-6 py-2.5 rounded-xl font-bold transition shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 flex items-center">
                    <i class="fas fa-save mr-2"></i> Registrar
                </button>
            </div>
        </div>
    </div>
    
    <div v-if="modalEditarAveria" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm flex justify-center items-center z-50 p-4">
        <div class="bg-white p-6 rounded-2xl w-full max-w-md shadow-2xl">
            <h3 class="font-bold text-xl mb-4 text-slate-800 border-b pb-2">Editar Avería</h3>
            
            <div class="space-y-4">
                <div class="bg-gray-50 p-3 rounded-lg border border-gray-100">
                    <div class="text-xs font-bold text-gray-400 uppercase">Vehículo</div>
                    <div class="font-bold text-lg text-slate-700">{{ averiaEnEdicion.vehiculoMatricula }} <span class="text-xs font-normal text-gray-500">({{ averiaEnEdicion.tipoVehiculo }})</span></div>
                </div>
                
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">Descripción</label>
                    <input v-model="averiaEnEdicion.descripcion" class="w-full border p-2 rounded-lg bg-gray-50 outline-none focus:border-blue-500">
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">Fecha Inicio</label>
                        <input type="date" v-model="averiaEnEdicion.fechaInicio" class="w-full border p-2 rounded-lg bg-gray-50 outline-none focus:border-blue-500">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">Fecha Fin</label>
                        <input type="date" v-model="averiaEnEdicion.fechaFin" class="w-full border p-2 rounded-lg bg-gray-50 outline-none focus:border-blue-500">
                        <div class="text-[10px] text-gray-400 mt-1 italic">Dejar vacío si sigue activa</div>
                    </div>
                </div>
            </div>

            <div class="mt-6 flex justify-end gap-3">
                <button @click="modalEditarAveria = false" class="px-4 py-2 rounded-lg font-bold text-slate-500 hover:bg-gray-100 transition">Cancelar</button>
                <button @click="guardarEdicionAveria" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-bold transition shadow-lg">Guardar Cambios</button>
            </div>
        </div>
    </div>

    <div v-if="toastMsg" class="fixed bottom-6 right-6 bg-slate-800 text-white px-6 py-3 rounded-xl shadow-2xl z-[100] animate-pop flex items-center"><i class="fas fa-check-circle text-green-400 mr-3"></i> {{ toastMsg }}</div>

</div>

<script>
    const { createApp, ref, computed, onMounted, watch, nextTick } = Vue

    createApp({
        setup() {
            const vistaActual = ref('inicio'); 
            const calendarView = ref('month'); 
            const fechaCalendario = ref(new Date());
            const colores = ['#bae6fd', '#bbf7d0', '#fecaca', '#fde68a', '#ddd6fe', '#e2e8f0', '#fed7aa', '#a5f3fc', '#d9f99d', '#fbcfe8', '#93c5fd', '#cbd5e1'];
            const menuMovilAbierto = ref(false);

            const choferes = ref([]);
            const tiposChofer = ref([]); 
            const tractoras = ref([]); 
            const remolques = ref([]); 
            const rutas = ref([]); 
            const viajes = ref([]);
            const citas = ref([]);
            const averias = ref([]);
            const nuevaCita = ref({ choferId: "", fecha: new Date().toISOString().split('T')[0], motivo: "" });
            const nuevaAveria = ref({ tipoVehiculo: '', vehiculoId: '', fechaInicio: new Date().toISOString().split('T')[0], descripcion: '' });
            const mostrarModalAveria = ref(false);

            // VARIABLES NUEVAS PARA FILTRADO Y EDICIÓN DE AVERÍAS
            const filtrosAverias = ref({ vehiculoId: '', desde: '', hasta: '' });
            const modalEditarAveria = ref(false);
            const averiaEnEdicion = ref({});

            const toastMsg = ref(null);
            const tooltip = ref({ visible: false, x: 0, y: 0, data: {} });
            
            const t = new Date();
            const firstDay = new Date(t.getFullYear(), t.getMonth(), 1).toISOString().split('T')[0];
            const lastDay = new Date(t.getFullYear(), t.getMonth() + 1, 0).toISOString().split('T')[0];
            const todayStr = t.toISOString().split('T')[0];

            const fechaDiario = ref(todayStr);
            const metricChofer = ref('revenue');

            const mostrarModalViaje = ref(false);
            const modoEdicion = ref(false); 
            const modalAdmin = ref(null); 
            const idEdicionAdmin = ref(null); 
            const idViajeEditando = ref(null);
            
            const nuevoViaje = ref({ fechaSalida: todayStr, horaSalida: '08:00', fechaLlegada: todayStr, horaLlegada: '18:00', rutaId: '', rutaNombreManual: '', choferId: '', chofer2Id: null, tractoraId: '', remolqueId: '', precioIda: 0, precioVuelta: 0, color: '#bae6fd', cargadorId: null, fechaSalidaCargador: todayStr, horaSalidaCargador: '08:00', fechaLlegadaCargador: todayStr, horaLlegadaCargador: '18:00' });
            const formAdmin = ref({ nombre: '', apellidos: '', datoExtra: '', origen: '', destino: '', km: '', itv: '', atp: '', tacografo: '', termografo: '', dni: '', telefono: '', tipoId: null });
            
            const filtrosContabilidad = ref({ desde: firstDay, hasta: lastDay });
            const mostrarDropdownRutasAnalisis = ref(false);
            const rutasAnalisisSeleccionadas = ref([]);
            const filtrosChofer = ref({ desde: firstDay, hasta: lastDay });
            const filtrosCalendario = ref({ texto: '', fecha: '', customStart: todayStr, customEnd: new Date(t.getFullYear(), t.getMonth() + 1, t.getDate()).toISOString().split('T')[0] });
            
            let revenueChart = null; let driverChart = null; let efficiencyChart = null; let dashboardRevenueChart = null; let averiasChart = null;

            // UTILS
            const formatDate = (dateStr) => { if(!dateStr) return ''; const [y,m,d] = dateStr.split('-'); return `${d}/${m}/${y}`; };
            const formatMoney = (n) => (n || 0).toLocaleString('es-ES', { style: 'currency', currency: 'EUR', minimumFractionDigits: 2 });
            const esHoy = (f) => f === new Date().toISOString().split('T')[0];
            const formatHours = (h) => { const hours = Math.floor(h); const minutes = Math.round((h - hours) * 60); if (hours === 0 && minutes === 0) return '-'; return `${hours}h ${minutes > 0 ? minutes + 'm' : ''}`; };
            const hexToRgba = (hex, alpha) => { if (!hex) return 'rgba(255,255,255,1)'; let r = parseInt(hex.slice(1, 3), 16), g = parseInt(hex.slice(3, 5), 16), b = parseInt(hex.slice(5, 7), 16); return `rgba(${r}, ${g}, ${b}, ${alpha})`; };
            const getHomePercent = (c) => { const total = c.horas + c.horasCasa; return total > 0 ? Math.round((c.horasCasa / total) * 100) : 0; };
            const getTipoChoferNombre = (id) => { const t = tiposChofer.value.find(x => x.id === id); return t ? t.nombre : ''; };
            const getFullDriverName = (driver) => { if (!driver) return ''; return `${driver.nombre} ${driver.apellidos || ''}`.trim(); };
            const routesSelected = (id) => rutasAnalisisSeleccionadas.value.length === 0 || rutasAnalisisSeleccionadas.value.includes(id);
            const obtenerChoferData = (id, field) => { const c = choferes.value.find(x => x.id === id); return c ? c[field] : ''; };

            // AVERÍAS
            const calcularDiasAveria = (averia) => {
                if (!averia) return 0;
                const inicio = new Date(averia.fechaInicio);
                const fin = averia.fechaFin ? new Date(averia.fechaFin) : new Date();
                const diff = Math.ceil((fin - inicio) / (1000 * 60 * 60 * 24));
                return Math.max(1, diff);
            };

            const averiasActivas = computed(() => averias.value.filter(a => a.estado === 'activa'));

            // COMPUTED PARA FILTRAR AVERÍAS
            const averiasFiltradas = computed(() => {
                return averias.value.filter(a => {
                    // 1. Filtro por vehículo (usamos matrícula que guardamos en vehiculoMatricula)
                    if (filtrosAverias.value.vehiculoId && a.vehiculoMatricula !== filtrosAverias.value.vehiculoId) {
                        return false;
                    }

                    // 2. Filtro por fechas (Rango solapado)
                    const fDesde = filtrosAverias.value.desde;
                    const fHasta = filtrosAverias.value.hasta;

                    if (fDesde || fHasta) {
                        const averiaInicio = new Date(a.fechaInicio);
                        const averiaFin = a.fechaFin ? new Date(a.fechaFin) : new Date('9999-12-31'); // Si es activa, asumimos futuro lejano
                        
                        const rangoInicio = fDesde ? new Date(fDesde) : new Date('2000-01-01');
                        const rangoFin = fHasta ? new Date(fHasta) : new Date('9999-12-31');

                        // Lógica de solapamiento de rangos
                        if (averiaFin < rangoInicio || averiaInicio > rangoFin) {
                            return false;
                        }
                    }

                    return true;
                }).sort((a, b) => new Date(b.fechaInicio) - new Date(a.fechaInicio)); // Ordenar por fecha inicio descendente
            });

            const vehiculosEnAveria = computed(() => {
                const activas = averiasActivas.value;
                return {
                    tractoras: activas.filter(a => a.tipoVehiculo === 'tractora').map(a => a.vehiculoId),
                    remolques: activas.filter(a => a.tipoVehiculo === 'remolque').map(a => a.vehiculoId)
                };
            });

            const vehiculosDisponiblesAveria = computed(() => {
                if (nuevaAveria.value.tipoVehiculo === 'tractora') return tractoras.value;
                if (nuevaAveria.value.tipoVehiculo === 'remolque') return remolques.value;
                return [];
            });

            const estaEnAveria = (vehiculoId, tipo) => {
                return averiasActivas.value.some(a => a.vehiculoId === vehiculoId && a.tipoVehiculo === tipo);
            };

            const getAveriaActiva = (vehiculoId, tipo) => {
                return averiasActivas.value.find(a => a.vehiculoId === vehiculoId && a.tipoVehiculo === tipo);
            };

            const getVehiculoClass = (vehiculo, tipo) => {
                if (vehiculo.status === 'active') return 'bg-white border-blue-200';
                if (estaEnAveria(vehiculo.id, tipo)) return 'bg-red-50 border-red-200';
                return 'bg-gray-50 border-gray-200';
            };

            const agregarAveria = () => {
                if (!nuevaAveria.value.tipoVehiculo || !nuevaAveria.value.vehiculoId || !nuevaAveria.value.descripcion) {
                    return alert("Completa todos los campos");
                }
                const vehiculo = nuevaAveria.value.tipoVehiculo === 'tractora' 
                    ? tractoras.value.find(t => t.id === nuevaAveria.value.vehiculoId)
                    : remolques.value.find(r => r.id === nuevaAveria.value.vehiculoId);
                
                averias.value.push({
                    id: Date.now(),
                    tipoVehiculo: nuevaAveria.value.tipoVehiculo,
                    vehiculoId: nuevaAveria.value.vehiculoId,
                    vehiculoMatricula: vehiculo?.matricula || 'N/A',
                    fechaInicio: nuevaAveria.value.fechaInicio,
                    fechaFin: null,
                    descripcion: nuevaAveria.value.descripcion,
                    estado: 'activa'
                });
                nuevaAveria.value = { tipoVehiculo: '', vehiculoId: '', fechaInicio: todayStr, descripcion: '' };
                toastMsg.value = "Avería registrada"; setTimeout(() => toastMsg.value = null, 2000);
            };

            const resolverAveria = (id) => {
                const idx = averias.value.findIndex(a => a.id === id);
                if (idx !== -1) {
                    averias.value[idx].estado = 'resuelta';
                    averias.value[idx].fechaFin = new Date().toISOString().split('T')[0];
                    toastMsg.value = "Avería resuelta"; setTimeout(() => toastMsg.value = null, 2000);
                }
            };

            const eliminarAveria = (id) => {
                if (confirm('¿Eliminar esta avería?')) {
                    averias.value = averias.value.filter(a => a.id !== id);
                }
            };

            // FUNCIONES NUEVAS PARA EDICIÓN Y FILTROS DE AVERÍAS
            const limpiarFiltrosAverias = () => {
                filtrosAverias.value = { vehiculoId: '', desde: '', hasta: '' };
            };

            const abrirEditarAveria = (averia) => {
                averiaEnEdicion.value = { ...averia };
                modalEditarAveria.value = true;
            };

            const guardarEdicionAveria = () => {
                const idx = averias.value.findIndex(a => a.id === averiaEnEdicion.value.id);
                if (idx !== -1) {
                    const editada = averiaEnEdicion.value;
                    if (editada.fechaFin) {
                        editada.estado = 'resuelta';
                    } else {
                        editada.estado = 'activa';
                        editada.fechaFin = null;
                    }
                    averias.value[idx] = editada;
                    modalEditarAveria.value = false;
                    toastMsg.value = "Avería actualizada";
                    setTimeout(() => toastMsg.value = null, 2000);
                }
            };

            const agregarCita = () => { if (!nuevaCita.value.choferId || !nuevaCita.value.motivo) return alert("Falta Chófer o Motivo"); citas.value.push({ id: Date.now(), choferId: nuevaCita.value.choferId, fecha: nuevaCita.value.fecha, motivo: nuevaCita.value.motivo }); nuevaCita.value.motivo = ""; };
            const borrarCita = (id) => { if(confirm("¿Borrar cita?")) citas.value = citas.value.filter(c => c.id !== id); };
            const citasPendientes = computed(() => citas.value.sort((a,b) => a.fecha.localeCompare(b.fecha)));

            // CHARTS
            const renderDashboardCharts = () => {
                const ctx = document.getElementById('dashboardRevenueChart'); if(ctx && dashboardRevenueChart) dashboardRevenueChart.destroy();
                if(ctx) dashboardRevenueChart = new Chart(ctx, { type: 'line', data: { labels: ['S1','S2','S3','S4'], datasets: [{label:'Total', data:[1000,2000,1500,3000], borderColor:'#3b82f6', tension:0.4}] }, options:{responsive:true,maintainAspectRatio:false} });
                const ctx2 = document.getElementById('efficiencyChart'); if(ctx2 && efficiencyChart) efficiencyChart.destroy();
                if(ctx2) efficiencyChart = new Chart(ctx2, { type: 'doughnut', data: { datasets: [{data:[75,25], backgroundColor:['#3b82f6','#f1f5f9']}] }, options:{responsive:true,maintainAspectRatio:false, cutout:'80%'} });
            };

            const renderAveriasChart = () => {
                const ctx = document.getElementById('averiasChart'); 
                if(ctx && averiasChart) averiasChart.destroy();
                if(ctx) {
                    const vehiculosConAverias = {};
                    averias.value.forEach(a => {
                        if (!vehiculosConAverias[a.vehiculoMatricula]) {
                            vehiculosConAverias[a.vehiculoMatricula] = { total: 0, activa: false };
                        }
                        vehiculosConAverias[a.vehiculoMatricula].total += calcularDiasAveria(a);
                        if (a.estado === 'activa') vehiculosConAverias[a.vehiculoMatricula].activa = true;
                    });
                    
                    const labels = Object.keys(vehiculosConAverias);
                    const data = Object.values(vehiculosConAverias).map(v => v.total);
                    const colors = Object.values(vehiculosConAverias).map(v => v.activa ? '#ef4444' : '#94a3b8');
                    
                    averiasChart = new Chart(ctx, { 
                        type: 'bar', 
                        data: { 
                            labels, 
                            datasets: [{
                                label: 'Días en avería', 
                                data, 
                                backgroundColor: colors,
                                borderRadius: 6
                            }] 
                        }, 
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { display: false }
                            },
                            scales: {
                                y: { beginAtZero: true, title: { display: true, text: 'Días' } }
                            }
                        } 
                    });
                }
            };

            const renderChart = () => {
                const ctx = document.getElementById('revenueChart'); if(ctx && revenueChart) revenueChart.destroy();
                if(ctx) {
                    const grouped = {}; 
                    resumenContabilidad.value.lista.forEach(v => { if (!grouped[v.rutaNombre]) grouped[v.rutaNombre] = {ida:0, vuelta:0}; grouped[v.rutaNombre].ida += (v.precioIda || 0); grouped[v.rutaNombre].vuelta += (v.precioVuelta || 0); });
                    revenueChart = new Chart(ctx, { type: 'bar', data: { labels: Object.keys(grouped), datasets: [{label:'Ida', data: Object.values(grouped).map(x=>x.ida), backgroundColor:'#3b82f6'}, {label:'Vuelta', data: Object.values(grouped).map(x=>x.vuelta), backgroundColor:'#f97316'}] }, options:{responsive:true,maintainAspectRatio:false} });
                }
            };

            const renderDriverChart = () => {
                const ctx = document.getElementById('driverChart'); if(ctx && driverChart) driverChart.destroy();
                if(ctx) {
                    const labels = resumenChoferes.value.lista.map(c => getFullDriverName(c));
                    let data, label, color;
                    if (metricChofer.value === 'revenue') { data = resumenChoferes.value.lista.map(c => c.revenue); label = 'Facturación (€)'; color = '#10b981'; }
                    else if (metricChofer.value === 'viajes') { data = resumenChoferes.value.lista.map(c => c.viajes); label = 'Viajes'; color = '#64748b'; }
                    else { data = resumenChoferes.value.lista.map(c => c.horas); label = 'Horas Fuera'; color = '#9333ea'; }
                    driverChart = new Chart(ctx, { type: 'bar', data: { labels, datasets: [{label, data, backgroundColor: color}] }, options:{responsive:true,maintainAspectRatio:false} });
                }
            };

            const toggleRutaAnalisis = (id) => { if (rutasAnalisisSeleccionadas.value.includes(id)) rutasAnalisisSeleccionadas.value = rutasAnalisisSeleccionadas.value.filter(x => x !== id); else rutasAnalisisSeleccionadas.value.push(id); renderChart(); };

            // COMPUTED
            const alertasVencimiento = computed(() => {
                const alertas = []; const now = new Date(); now.setHours(0, 0, 0, 0);
                const comprobar = (item, tipo, doc, fechaStr) => { if (!fechaStr) return; const fechaVencimiento = new Date(fechaStr); const diffTime = fechaVencimiento - now; const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); if (diffDays <= 31) { alertas.push({ tipoVehiculo: tipo, matricula: item.matricula || item.nombre, doc: doc, diasRestantes: diffDays, fecha: fechaStr }); } };
                tractoras.value.forEach(t => { comprobar(t, 'Tractora', 'ITV', t.itv); comprobar(t, 'Tractora', 'Tacógrafo', t.tacografo); }); 
                remolques.value.forEach(r => { comprobar(r, 'Remolque', 'ITV', r.itv); comprobar(r, 'Remolque', 'ATP', r.atp); comprobar(r, 'Remolque', 'Termógrafo', r.termografo); });
                return alertas.sort((a,b) => a.diasRestantes - b.diasRestantes);
            });

            const viajesDiario = computed(() => viajes.value.filter(v => v.fechaSalida === fechaDiario.value).sort((a,b) => a.horaSalida.localeCompare(b.horaSalida)));
            const nombreMesActual = computed(() => fechaCalendario.value.toLocaleString('es-ES', { month: 'long', year: 'numeric' }));
            const diasDelMes = computed(() => { const y=fechaCalendario.value.getFullYear(), m=fechaCalendario.value.getMonth(), d=new Date(y,m+1,0).getDate(); return Array.from({length:d},(_,i)=>{ const dt=new Date(y,m,i+1); return {numero:i+1, fechaStr:new Date(dt.getTime()-dt.getTimezoneOffset()*60000).toISOString().split('T')[0]}; }); });
            const paddingDias = computed(() => { let p=new Date(fechaCalendario.value.getFullYear(),fechaCalendario.value.getMonth(),1).getDay()-1; return p<0?6:p; });
            const filtrarViajesCalendario = (f) => viajes.value.filter(v => v.fechaSalida === f).sort((a,b) => a.horaSalida.localeCompare(b.horaSalida));
            
            const diasRango = computed(() => {
                const start = new Date(filtrosCalendario.value.customStart); const end = new Date(filtrosCalendario.value.customEnd); const dias = [];
                for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) { const fechaStr = d.toISOString().split('T')[0]; const viajesDia = viajes.value.filter(v => v.fechaSalida === fechaStr).sort((a,b) => a.horaSalida.localeCompare(b.horaSalida)); if (viajesDia.length > 0) { dias.push({ fecha: fechaStr, numero: d.getDate(), mes: d.toLocaleDateString('es-ES', { month: 'short' }), diaSemana: d.toLocaleDateString('es-ES', { weekday: 'short' }), viajes: viajesDia }); } }
                return dias;
            });

            const resumenContabilidad = computed(() => { 
                const { desde, hasta } = filtrosContabilidad.value; 
                const lista = viajes.value.filter(v => v.fechaSalida >= desde && v.fechaSalida <= hasta && routesSelected(v.rutaId));
                const granTotal = lista.reduce((a, v) => a + (v.precioIda||0) + (v.precioVuelta||0), 0);
                const driverMap = {};
                lista.forEach(v => { const add = (id, name, amount) => { if(!id) return; if(!driverMap[id]) driverMap[id] = {id, nombre: name, total: 0, viajes: 0}; driverMap[id].total += amount; driverMap[id].viajes += 1; }; add(v.choferId, v.choferNombre, (v.precioIda||0) + (v.precioVuelta||0)); });
                return { granTotal, lista, desgloseChoferes: Object.values(driverMap).sort((a,b) => b.total - a.total) }; 
            });

            // RESUMEN CHÓFERES MEJORADO
            const resumenChoferes = computed(() => {
                const { desde, hasta } = filtrosChofer.value;
                if (!desde || !hasta) return { lista: [], totalHoras: 0 };

                const stats = {};
                choferes.value.forEach(c => {
                    stats[c.id] = { id: c.id, nombre: getFullDriverName(c), tipoNombre: getTipoChoferNombre(c.tipoId), viajes: 0, horas: 0, horasCasa: 0, revenue: 0, rawTrips: [] };
                });

                viajes.value.forEach(v => {
                    if (v.fechaSalida >= desde && v.fechaSalida <= hasta) {
                        const calcMs = (fs, hs, fl, hl) => { 
                            if (!fs || !hs || !fl || !hl) return 0; 
                            return (new Date(`${fl}T${hl}`) - new Date(`${fs}T${hs}`)); 
                        };

                        let ms1 = 0, ms2 = 0, msC = 0;
                        const tripMs = calcMs(v.fechaSalida, v.horaSalida, v.fechaLlegada, v.horaLlegada);

                        if (v.choferId) ms1 = tripMs;
                        if (v.chofer2Id) ms2 = tripMs;

                        if (v.cargadorId) {
                            const fs = v.fechaSalidaCargador || v.fechaSalida;
                            const hs = v.horaSalidaCargador || v.horaSalida;
                            const fl = v.fechaLlegadaCargador || v.fechaLlegada;
                            const hl = v.horaLlegadaCargador || v.horaLlegada;
                            msC = calcMs(fs, hs, fl, hl);
                            if (msC <= 0 || msC > (tripMs + 86400000)) { msC = tripMs; }
                        }

                        const totalWorkMs = ms1 + ms2 + msC;
                        const totalRevenue = (v.precioIda || 0) + (v.precioVuelta || 0);

                        const processTimeBlock = (fSalida, hSalida, fLlegada, hLlegada, msDuration) => {
                            if (msDuration <= 0) return null;
                            const durationHours = msDuration / 3600000;
                            const share = totalWorkMs > 0 ? (msDuration / totalWorkMs) * totalRevenue : 0;
                            const start = new Date(`${fSalida}T${hSalida}`);
                            const end = new Date(`${fLlegada}T${hLlegada}`);
                            return { duration: durationHours, revenueShare: share, start, end };
                        };

                        if (v.choferId && stats[v.choferId]) {
                            const res = processTimeBlock(v.fechaSalida, v.horaSalida, v.fechaLlegada, v.horaLlegada, ms1);
                            if (res) { stats[v.choferId].viajes++; stats[v.choferId].horas += res.duration; stats[v.choferId].revenue += res.revenueShare; stats[v.choferId].rawTrips.push({ start: res.start, end: res.end }); }
                        }
                        if (v.chofer2Id && stats[v.chofer2Id]) {
                            const res = processTimeBlock(v.fechaSalida, v.horaSalida, v.fechaLlegada, v.horaLlegada, ms2);
                            if (res) { stats[v.chofer2Id].viajes++; stats[v.chofer2Id].horas += res.duration; stats[v.chofer2Id].revenue += res.revenueShare; stats[v.chofer2Id].rawTrips.push({ start: res.start, end: res.end }); }
                        }
                        if (v.cargadorId && stats[v.cargadorId]) {
                            const fs = v.fechaSalidaCargador || v.fechaSalida;
                            const hs = v.horaSalidaCargador || v.horaSalida;
                            const fl = v.fechaLlegadaCargador || v.fechaLlegada;
                            const hl = v.horaLlegadaCargador || v.horaLlegada;
                            const res = processTimeBlock(fs, hs, fl, hl, msC);
                            if (res) { stats[v.cargadorId].viajes++; stats[v.cargadorId].horas += res.duration; stats[v.cargadorId].revenue += res.revenueShare; stats[v.cargadorId].rawTrips.push({ start: res.start, end: res.end }); }
                        }
                    }
                });

                Object.values(stats).forEach(chofer => {
                    if (chofer.rawTrips.length > 1) {
                        chofer.rawTrips.sort((a, b) => a.start - b.start);
                        let totalHome = 0;
                        for (let i = 0; i < chofer.rawTrips.length - 1; i++) {
                            const diff = (chofer.rawTrips[i + 1].start - chofer.rawTrips[i].end) / 3600000;
                            if (diff > 0) totalHome += diff;
                        }
                        chofer.horasCasa = totalHome;
                    }
                });

                return { lista: Object.values(stats).sort((a, b) => b.revenue - a.revenue), totalHoras: Object.values(stats).reduce((a, s) => a + s.horas, 0) };
            });

            const analisisFlota = computed(() => {
                const now = new Date();
                const mapV = (l, k) => l.map(i => ({...i, status: viajes.value.some(v => (k==='tractora'?v.tractoraId:v.remolqueId) === i.id && now >= new Date(`${v.fechaSalida}T${v.horaSalida}`) && now <= new Date(`${v.fechaLlegada}T${v.horaLlegada}`)) ? 'active' : 'idle'}));
                return { tractoras: mapV(tractoras.value, 'tractora'), remolques: mapV(remolques.value, 'remolque') };
            });

            const dashboardStats = computed(() => {
                const now = new Date(); const start = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split('T')[0];
                const list = viajes.value.filter(v => v.fechaSalida >= start);
                const salidasHoy = viajes.value.filter(v => v.fechaSalida === now.toISOString().split('T')[0]);
                const rutasStats = rutas.value.map((r, i) => ({ nombre:r.nombre, actual: list.filter(v => v.rutaId === r.id).reduce((s,v) => s+(v.precioIda||0)+(v.precioVuelta||0),0), diff:0, pct:0, color: colores[i%colores.length] })).sort((a,b)=>b.actual-a.actual);
                return { comparativaRutas: rutasStats, eficiencia: 75, salidasHoy, alertas: alertasVencimiento.value };
            });

            // EVENT HANDLERS
            const cambiarDiaDiario = (days) => { const d = new Date(fechaDiario.value); d.setDate(d.getDate() + days); fechaDiario.value = d.toISOString().split('T')[0]; };
            const setDiaDiarioHoy = () => { fechaDiario.value = new Date().toISOString().split('T')[0]; };
            const cambiarMes = (d) => { fechaCalendario.value = new Date(fechaCalendario.value.setMonth(fechaCalendario.value.getMonth()+d)); };
            const irHoy = () => fechaCalendario.value = new Date();

            const abrirModalViaje = (f) => { modoEdicion.value = false; idViajeEditando.value = null; const d = f || new Date().toISOString().split('T')[0]; nuevoViaje.value = { fechaSalida: d, horaSalida: '08:00', fechaLlegada: d, horaLlegada: '18:00', rutaId: '', rutaNombreManual: '', choferId: '', chofer2Id: null, tractoraId: '', remolqueId: '', precioIda: 0, precioVuelta: 0, color: '#bae6fd', cargadorId: null, fechaSalidaCargador: d, horaSalidaCargador: '08:00', fechaLlegadaCargador: d, horaLlegadaCargador: '18:00' }; mostrarModalViaje.value = true; };
            
            // EDITAR VIAJE CORREGIDO
            const editarViaje = (v) => {
                modoEdicion.value = true;
                idViajeEditando.value = v.id;
                
                const r = rutas.value.find(x => x.nombre === v.rutaNombre);
                const c1 = choferes.value.find(x => x.nombre === v.choferNombre);
                const c2 = v.chofer2Nombre ? choferes.value.find(x => x.nombre === v.chofer2Nombre) : null;
                
                let cargador = null;
                if (v.cargadorId) { cargador = choferes.value.find(x => x.id === v.cargadorId); } 
                else if (v.cargadorNombre) { cargador = choferes.value.find(x => x.nombre === v.cargadorNombre); }
                
                const t = tractoras.value.find(x => x.matricula === v.tractoraPlaca);
                const rem = remolques.value.find(x => x.matricula === v.remolquePlaca);

                nuevoViaje.value = {
                    ...v,
                    rutaId: r?.id || '',
                    rutaNombreManual: v.rutaNombreManual || v.rutaNombre,
                    choferId: c1?.id || '',
                    chofer2Id: c2?.id || null,
                    tractoraId: t?.id || '',
                    remolqueId: rem?.id || '',
                    color: v.color || '#bae6fd',
                    cargadorId: cargador ? cargador.id : null,
                    fechaSalidaCargador: v.fechaSalidaCargador || v.fechaSalida,
                    horaSalidaCargador: v.horaSalidaCargador || v.horaSalida,
                    fechaLlegadaCargador: v.fechaLlegadaCargador || v.fechaLlegada,
                    horaLlegadaCargador: v.horaLlegadaCargador || v.horaLlegada,
                    precioIda: v.precioIda || 0,
                    precioVuelta: v.precioVuelta || 0
                };
                mostrarModalViaje.value = true;
            };
            
            const alSeleccionarRuta = () => { const r = rutas.value.find(x => x.id === nuevoViaje.value.rutaId); if (r) nuevoViaje.value.rutaNombreManual = r.nombre; };

            // GUARDAR VIAJE CORREGIDO
            const guardarViaje = () => {
                const r = rutas.value.find(x => x.id === nuevoViaje.value.rutaId);
                const c1 = choferes.value.find(x => x.id === nuevoViaje.value.choferId);
                const t = tractoras.value.find(x => x.id === nuevoViaje.value.tractoraId);
                const rem = remolques.value.find(x => x.id === nuevoViaje.value.remolqueId);

                if (!r || !c1 || !t || !rem) return alert("Faltan datos de ruta, chófer o vehículos.");

                const c2 = nuevoViaje.value.chofer2Id ? choferes.value.find(x => x.id === nuevoViaje.value.chofer2Id) : null;
                const cargador = nuevoViaje.value.cargadorId ? choferes.value.find(x => x.id === nuevoViaje.value.cargadorId) : null;

                const vObj = {
                    ...nuevoViaje.value,
                    rutaNombre: r.nombre,
                    rutaNombreManual: nuevoViaje.value.rutaNombreManual || r.nombre,
                    choferNombre: c1.nombre,
                    chofer2Nombre: c2 ? c2.nombre : null,
                    tractoraPlaca: t.matricula,
                    remolquePlaca: rem.matricula,
                    cargadorId: cargador ? cargador.id : null,
                    cargadorNombre: cargador ? cargador.nombre : null,
                    fechaSalidaCargador: nuevoViaje.value.fechaSalidaCargador,
                    horaSalidaCargador: nuevoViaje.value.horaSalidaCargador,
                    fechaLlegadaCargador: nuevoViaje.value.fechaLlegadaCargador,
                    horaLlegadaCargador: nuevoViaje.value.horaLlegadaCargador
                };

                if (modoEdicion.value) {
                    const idx = viajes.value.findIndex(v => v.id === idViajeEditando.value);
                    if (idx !== -1) { viajes.value[idx] = { ...viajes.value[idx], ...vObj }; }
                } else {
                    viajes.value.push({ id: Date.now(), ...vObj });
                }
                mostrarModalViaje.value = false;
            };
            
            const eliminarViajeActual = () => { if(confirm("¿Eliminar?")) { viajes.value = viajes.value.filter(v=>v.id!==idViajeEditando.value); mostrarModalViaje.value=false; } };
            const abrirAdmin = (t) => { modalAdmin.value = t; idEdicionAdmin.value = null; formAdmin.value = { nombre: '', apellidos: '', datoExtra: '', origen: '', destino: '', km: '', itv: '', atp: '', tacografo: '', termografo: '', dni: '', telefono: '', tipoId: null }; };
            const editarAdmin = (t, i) => { modalAdmin.value = t; idEdicionAdmin.value = i.id; if (t==='ruta') formAdmin.value={nombre:i.nombre, origen:i.origen, destino:i.destino, km:i.km}; else if (t==='tractora') formAdmin.value={nombre:i.modelo, datoExtra:i.matricula, itv: i.itv || '', tacografo: i.tacografo || ''}; else if (t==='remolque') formAdmin.value={nombre:i.tipo, datoExtra:i.matricula, itv: i.itv || '', atp: i.atp || '', termografo: i.termografo || ''}; else if(t==='tipoChofer') formAdmin.value={nombre:i.nombre}; else formAdmin.value={nombre:i.nombre, apellidos: i.apellidos||'', datoExtra:i.licencia, dni:i.dni||'', telefono:i.telefono||'', tipoId:i.tipoId||null}; };
            const guardarAdmin = () => { if(!formAdmin.value.nombre) return alert("Nombre obligatorio"); const {nombre, apellidos, datoExtra, origen, destino, km, itv, atp, tacografo, termografo, dni, telefono, tipoId} = formAdmin.value; const item = {id: idEdicionAdmin.value || Date.now()}; const update = (arr, obj) => { const idx=arr.findIndex(x=>x.id===item.id); if(idx!==-1) arr[idx]=obj; else arr.push(obj); }; if (modalAdmin.value === 'chofer') update(choferes.value, {...item, nombre, apellidos, licencia: datoExtra, dni, telefono, tipoId}); if (modalAdmin.value === 'tractora') update(tractoras.value, {...item, modelo: nombre, matricula: datoExtra, itv, tacografo}); if (modalAdmin.value === 'remolque') update(remolques.value, {...item, tipo: nombre, matricula: datoExtra, itv, atp, termografo}); if (modalAdmin.value === 'ruta') update(rutas.value, {...item, nombre, origen, destino, km}); if (modalAdmin.value === 'tipoChofer') update(tiposChofer.value, {...item, nombre}); modalAdmin.value = null; };
            const eliminarItem = (t, id) => { if(confirm('¿Eliminar?')) { if(t==='chofer') choferes.value=choferes.value.filter(x=>x.id!==id); if(t==='ruta') rutas.value=rutas.value.filter(x=>x.id!==id); if(t==='tractora') tractoras.value=tractoras.value.filter(x=>x.id!==id); if(t==='remolque') remolques.value=remolques.value.filter(x=>x.id!==id); if(t==='tipoChofer') tiposChofer.value=tiposChofer.value.filter(x=>x.id!==id); }};
            const descargarCopia = () => { const a = document.createElement('a'); a.href = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify({choferes:choferes.value, tiposChofer:tiposChofer.value, tractoras:tractoras.value, remolques:remolques.value, rutas:rutas.value, viajes:viajes.value, citas: citas.value, averias: averias.value})); a.download = "backup_fleet.json"; a.click(); };
            const restaurarCopia = (e) => { const r = new FileReader(); r.onload = (ev) => { if(confirm("¿Restaurar?")) { const d = JSON.parse(ev.target.result); choferes.value=d.choferes; tiposChofer.value=d.tiposChofer||[]; tractoras.value=d.tractoras; remolques.value=d.remolques; rutas.value=d.rutas; viajes.value=d.viajes; citas.value=d.citas||[]; averias.value=d.averias||[]; }}; r.readAsText(e.target.files[0]); };
            
            const copiarOrdenPortapapeles = (viaje) => { let c1 = choferes.value.find(c => c.id === viaje.choferId); let c2 = viaje.chofer2Id ? choferes.value.find(c => c.id === viaje.chofer2Id) : null; let cargadorInfoText = 'SIN ESPECIFICAR'; if (viaje.cargadorId) { const cargadorChofer = choferes.value.find(c => c.id === viaje.cargadorId); cargadorInfoText = `${cargadorChofer.nombre.toUpperCase()} ${cargadorChofer.telefono || ''}`; } else if (viaje.cargadorInfo) { cargadorInfoText = viaje.cargadorInfo; } const rutaTexto = (viaje.rutaNombreManual || viaje.rutaNombre).toUpperCase(); const texto = `CAMION\n${rutaTexto}\n${formatDate(viaje.fechaSalida)}\nMATRÍCULAS \n${viaje.tractoraPlaca}\n${viaje.remolquePlaca}\n\nCHOFER 1\n${getFullDriverName(c1).toUpperCase()}\n${c1?.dni||''}\nTELEFONO ${c1?.telefono||''}\n\n${c2 ? `CHOFER 2\n${getFullDriverName(c2).toUpperCase()}\n${c2.dni||''}\nTELEFONO ${c2.telefono||''}\n\n` : ''}CARGADOR\n${cargadorInfoText}`; navigator.clipboard.writeText(texto).then(() => { toastMsg.value = "Copiado al portapapeles"; setTimeout(() => toastMsg.value = null, 2000); }); };

            const cambiarVista = (v) => { vistaActual.value = v; nextTick(() => refreshCharts()); };
            const refreshCharts = () => { 
                if (vistaActual.value === 'inicio') renderDashboardCharts(); 
                if (vistaActual.value === 'contabilidad') renderChart(); 
                if (vistaActual.value === 'analisisChofer') renderDriverChart(); 
                if (vistaActual.value === 'flota') renderAveriasChart();
            };

            onMounted(() => {
                try { 
                    const saved = localStorage.getItem('fleetManagerData_v32'); 
                    if (saved) { 
                        const data = JSON.parse(saved); 
                        choferes.value = (data.choferes || []).map(c => { if (!c.apellidos && c.nombre.includes(' ')) { const parts = c.nombre.split(' '); return { ...c, nombre: parts[0], apellidos: parts.slice(1).join(' ') }; } return c; }); 
                        tiposChofer.value = data.tiposChofer || []; 
                        tractoras.value = (data.tractoras || []).map(t => ({ ...t, tacografo: t.tacografo || '' })); 
                        remolques.value = data.remolques || []; 
                        rutas.value = data.rutas || []; 
                        citas.value = data.citas || [];
                        averias.value = data.averias || [];
                        viajes.value = (data.viajes || []).map(v => { const cargadorIdFromNombre = v.cargadorNombre ? (choferes.value.find(c => c.nombre === v.cargadorNombre)?.id || null) : null; return { ...v, precioIda: v.precioIda!==undefined?v.precioIda:(v.precio||0), precioVuelta: v.precioVuelta!==undefined?v.precioVuelta:0, cargadorNombre: v.cargadorNombre || (v.cargadorInfo && v.cargadorInfo !== 'FRANCISCO  672982487' ? v.cargadorInfo : null), cargadorId: v.cargadorId !== undefined ? v.cargadorId : cargadorIdFromNombre, fechaSalidaCargador: v.fechaSalidaCargador || v.fechaSalida, horaSalidaCargador: v.horaSalidaCargador || v.horaSalida, fechaLlegadaCargador: v.fechaLlegadaCargador || v.fechaLlegada, horaLlegadaCargador: v.horaLlegadaCargador || v.horaLlegada, rutaNombreManual: v.rutaNombreManual || v.rutaNombre }; }); 
                    } else { 
                        choferes.value = [{id:1, nombre:'Juan', apellidos: 'Pérez', licencia:'C+E', dni:'12345678A', telefono:'600000000'}]; rutas.value = [{id:1, nombre:'VELEZ MALAGA-PINTO-BARCELONA', km:600}, {id:2, nombre:'MOTRIL-PINTO-BCN', km:500}]; tractoras.value = [{id:1, matricula:'0052 LYL', modelo:'Volvo', tacografo: ''}]; remolques.value = [{id:1, matricula:'R 7759 BCL', tipo:'Lona'}]; tiposChofer.value = [{id:1, nombre:'Asalariado'}, {id:2, nombre:'Autónomo'}]; 
                    } 
                } catch (e) { console.error("Error al cargar datos:", e); choferes.value = []; tractoras.value = []; remolques.value = []; rutas.value = []; viajes.value = []; citas.value=[]; averias.value=[]; }
                const t = new Date(); const firstDay = new Date(t.getFullYear(), t.getMonth(), 1).toISOString().split('T')[0]; const lastDay = new Date(t.getFullYear(), t.getMonth() + 1, 0).toISOString().split('T')[0]; filtrosContabilidad.value = { desde: firstDay, hasta: lastDay }; filtrosChofer.value = { desde: firstDay, hasta: lastDay }; filtrosCalendario.value = { texto: '', fecha: '', customStart: firstDay, customEnd: lastDay }; filtrosAverias.value = { vehiculoId: '', desde: '', hasta: '' }; refreshCharts();
            });

            watch([choferes, tiposChofer, tractoras, remolques, rutas, viajes, citas, averias], () => { const data = { choferes: choferes.value, tiposChofer: tiposChofer.value, tractoras: tractoras.value, remolques: remolques.value, rutas: rutas.value, viajes: viajes.value, citas: citas.value, averias: averias.value }; localStorage.setItem('fleetManagerData_v32', JSON.stringify(data)); refreshCharts(); }, { deep: true });
            watch(metricChofer, () => { if (vistaActual.value === 'analisisChofer') renderDriverChart(); });

            return { vistaActual, calendarView, cambiarVista, nombreMesActual, diasDelMes, paddingDias, cambiarMes, irHoy, choferes, tiposChofer, tractoras, remolques, rutas, viajes, colores, filtrosCalendario, filtrarViajesCalendario, filtrosContabilidad, resumenContabilidad, mostrarModalViaje, modalAdmin, modoEdicion, nuevoViaje, formAdmin, idEdicionAdmin, abrirModalViaje, editarViaje, guardarViaje, eliminarViajeActual, abrirAdmin, editarAdmin, guardarAdmin, eliminarItem, descargarCopia, restaurarCopia, esHoy, formatMoney, alertasVencimiento, fechaDiario, viajesDiario, cambiarDiaDiario, setDiaDiarioHoy, copiarOrdenPortapapeles, toastMsg, obtenerChoferData, filtrosChofer, resumenChoferes, analisisFlota, dashboardStats, mostrarDropdownRutasAnalisis, rutasAnalisisSeleccionadas, toggleRutaAnalisis, routesSelected, metricChofer, formatDate, formatHours, getTipoChoferNombre, getFullDriverName, alSeleccionarRuta, diasRango, tooltip, getHomePercent, hexToRgba, citas, nuevaCita, agregarCita, borrarCita, citasPendientes, menuMovilAbierto, averias, nuevaAveria, mostrarModalAveria, averiasActivas, vehiculosEnAveria, vehiculosDisponiblesAveria, calcularDiasAveria, agregarAveria, resolverAveria, eliminarAveria, estaEnAveria, getAveriaActiva, getVehiculoClass, filtrosAverias, averiasFiltradas, limpiarFiltrosAverias, modalEditarAveria, averiaEnEdicion, abrirEditarAveria, guardarEdicionAveria };
        }
    }).mount('#app')
</script>

</body>
</html>